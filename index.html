<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BoostEx Trade — Торговый кабинет</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --soft:#0c1528; --text:#e5e7eb; --muted:#9ca3af;
    --brand:#06b6d4; --good:#22c55e; --bad:#ef4444; --border:#1f2937; --ring:#1e40af;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(60vw 40vh at 10% -10%, rgba(14,165,233,.12), transparent 40%),
      radial-gradient(60vw 40vh at 110% 10%, rgba(99,102,241,.12), transparent 35%),
      linear-gradient(180deg,#0b1220 0%, #0b1220 55%, #0f172a 100%);
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background-image:
      linear-gradient(to right, rgba(255,255,255,.03) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.03) 1px, transparent 1px);
    background-size: 48px 48px;
    mask-image: radial-gradient(80% 60% at 50% 10%, rgba(0,0,0,.5), transparent 100%);
  }
  .wrap{max-width:1100px; margin:0 auto; padding:20px}
  header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg,rgba(11,18,32,.8),rgba(11,18,32,.5)); backdrop-filter: blur(8px); border-bottom:1px solid var(--border)}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .right{margin-left:auto}
  .card{background:linear-gradient(180deg,var(--card),var(--soft)); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.2)}
  .h1{font-weight:700; font-size:18px}
  .h2{font-weight:600; font-size:16px}
  .muted{color:var(--muted)}
  .btn{background:var(--brand); color:#041018; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer}
  .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--border)}
  .btn.small{padding:8px 10px; font-weight:600; border-radius:8px}
  .input, .select{background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none}
  .input:focus, .select:focus{border-color:var(--ring); box-shadow: 0 0 0 3px rgba(30,64,175,.35)}
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  .kpi{background:var(--soft); border:1px solid var(--border); border-radius:12px; padding:12px}
  .kpi .val{font-size:22px; font-weight:800}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .table{width:100%; border-collapse:collapse}
  .table th,.table td{padding:10px; border-bottom:1px solid var(--border); text-align:left}
  .pnl-pos{color:var(--good)} .pnl-neg{color:var(--bad)}
  .tag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#0b1220; color:#cbd5e1}
  .canvas-wrap{background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:10px}
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:30}
  .modal.open{display:flex}
  .sheet{background:linear-gradient(180deg,#101a2e,#0d1628); border:1px solid var(--border); border-radius:16px; padding:18px; width:min(520px,92vw)}
  .tabs{display:flex; gap:8px; margin-bottom:18px;}
  .tab{padding:8px 22px; border-radius:10px 10px 0 0; background:var(--soft); color:var(--text); cursor:pointer; font-weight:600; border:1px solid var(--border); border-bottom:none;}
  .tab.active{background:var(--brand); color:#041018;}
  .tariff-table{width:100%; border-collapse:collapse; margin-bottom:16px;}
  .tariff-table th, .tariff-table td{padding:8px 10px; border-bottom:1px solid var(--border); font-size:13px;}
  .deal-list{font-size:13px; border-top:1px solid var(--border); margin-top:8px;}
  .deal-list th, .deal-list td{padding:6px 8px;}
  .deal-pnl-pos{color:var(--good);} .deal-pnl-neg{color:var(--bad);}
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<header style="display:none" id="mainHeader">
  <div class="wrap row">
    <div class="h1">BoostEx — торговый кабинет (демо)</div>
    <div class="row right">
      <span class="tag" id="statusTag">Оффлайн-симуляция</span>
      <button class="btn small" id="openDeposit">Депозит</button>
      <button class="btn small ghost" id="openWithdraw">Вывод</button>
    </div>
  </div>
</header>
<div id="authPage" style="display:block">
  <main class="wrap" style="max-width:400px; margin-top:50px;">
    <section class="card">
      <div class="h2" style="margin-bottom:12px;">Регистрация / Вход</div>
      <div class="row" style="margin-bottom:12px;">
        <input id="authEmail" class="input" style="min-width:220px" placeholder="email" />
      </div>
      <div class="row" style="margin-bottom:12px;">
        <input id="authPass" class="input" style="min-width:220px" placeholder="пароль" type="password" />
      </div>
      <div class="row">
        <button class="btn" id="authLoginBtn">Войти</button>
        <span id="authMsg" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:16px;font-size:13px;">Демо: используйте <b>admin@example.com / admin123</b></div>
    </section>
  </main>
</div>
<div id="cabinetPage" style="display:none">
  <header id="mainHeaderShow">
    <div class="wrap row">
      <div class="h1">BoostEx — торговый кабинет (демо)</div>
      <div class="row right">
        <span class="tag" id="statusTag2">Оффлайн-симуляция</span>
        <button class="btn small" id="openDeposit">Депозит</button>
        <button class="btn small ghost" id="openWithdraw">Вывод</button>
      </div>
    </div>
  </header>
  <main class="wrap" id="app">
    <div class="tabs">
      <div class="tab active" id="tab-cabinet">Кабинет</div>
      <div class="tab" id="tab-my-tariffs">Мои тарифы</div>
    </div>
    <div id="page-cabinet2">
      <section class="card" id="tariffSection">
        <div class="h2">Открыть новый тариф</div>
        <div class="row" style="margin-top:10px">
          <select id="tariffSelect" class="select">
            <option value="conservative">Начальный: $100–$700, 13% за 10 дней</option>
            <option value="balanced">Средний: $3000–$9000, 21% за 25 дней</option>
            <option value="aggressive">Максимальный: $10,000–$100,000, 35% за 47 дней</option>
          </select>
          <input id="tariffDeposit" class="input" type="number" placeholder="Сумма ($)" style="width:140px">
          <button class="btn" id="startTariffBtn">Запустить тариф</button>
        </div>
        <div id="tariffMsg" class="muted" style="margin-top:10px"></div>
      </section>
      <section class="card" id="tariffsListSection" style="margin-bottom:12px; display:none;">
        <div class="h2">Ваши тарифы</div>
        <div id="tariffsList"></div>
      </section>
      <section class="kpis">
        <div class="kpi"><div class="muted">Баланс (USD)</div><div class="val" id="kpiEquity">$—</div></div>
        <div class="kpi"><div class="muted">Доход (30д)</div><div class="val" id="kpiPnl">—</div></div>
        <div class="kpi"><div class="muted">Сделки</div><div class="val" id="kpiTrades">—</div></div>
        <div class="kpi"><div class="muted">Статус</div><div class="val">Онлайн</div></div>
      </section>
      <section class="grid2">
        <div class="card">
          <div class="h2">Балансы</div>
          <div id="balances" class="muted" style="margin-top:6px">Войдите, чтобы увидеть баланс.</div>
        </div>
        <div class="card">
          <div class="h2">Курсы (USD) — топ-10</div>
          <div id="prices" class="muted" style="margin-top:6px">—</div>
        </div>
      </section>
      <section class="card">
        <div class="row">
          <div class="h2">Кривая капитала</div>
        </div>
        <div class="canvas-wrap" style="margin-top:10px; position:relative;">
          <canvas id="equityChart" width="1000" height="280" style="cursor:pointer"></canvas>
        </div>
      </section>
      <section class="card">
        <div class="row">
          <div class="h2">Сделки (последние)</div>
          <div class="right row">
            <select id="symbolFilter" class="select">
              <option value="">Все инструменты</option>
              <option>BTC</option><option>ETH</option><option>BNB</option><option>SOL</option><option>TON</option>
            </select>
            <button class="btn small ghost" id="exportCsv">Экспорт CSV</button>
          </div>
        </div>
        <table class="table" style="margin-top:6px">
          <thead><tr><th>Время</th><th>Инструмент</th><th>Сторона</th><th>Кол-во</th><th>Цена</th><th>P&L ($)</th></tr></thead>
          <tbody id="trades"></tbody>
        </table>
      </section>
    </div>
    <div id="page-my-tariffs" style="display:none;">
      <section class="card">
        <div class="h2">Открытые и завершённые тарифы</div>
        <table class="tariff-table">
          <thead>
            <tr>
              <th>Тип</th><th>Сумма</th><th>Доходность</th><th>Доход</th><th>Старт</th><th>Финиш</th><th>Статус</th>
            </tr>
          </thead>
          <tbody id="myTariffsTable"></tbody>
        </table>
        <div id="myTariffsDeals"></div>
      </section>
    </div>
  </main>
</div>

<!-- Модалки депозит/вывод (display:none по умолчанию) -->
<div class="modal" id="modalDeposit">
  <div class="sheet">
    <div class="row"><div class="h2">Депозит</div><button class="btn small ghost right" data-close="deposit">Закрыть</button></div>
    <div class="row" style="margin-top:10px">
      <select id="depAsset" class="select">
        <option>USDT (TRC20)</option><option>USDC (TRC20)</option><option>BTC</option><option>ETH</option><option>TON</option>
      </select>
      <button class="btn small" id="genAddr">Сгенерировать адрес</button>
    </div>
    <div id="depInfo" class="muted" style="margin-top:10px">Выберите актив и сгенерируйте адрес пополнения.</div>
    <div id="qrBox" class="card" style="margin-top:10px; display:none">
      <div class="muted">QR-код (псевдо)</div>
      <canvas id="qr" width="220" height="220" style="margin-top:8px; background:#0b1220; border:1px solid var(--border); border-radius:10px"></canvas>
    </div>
  </div>
</div>
<div class="modal" id="modalWithdraw">
  <div class="sheet">
    <div class="row"><div class="h2">Вывод средств</div><button class="btn small ghost right" data-close="withdraw">Закрыть</button></div>
    <div class="row" style="margin-top:10px">
      <select id="wdAsset" class="select">
        <option>USDT (TRC20)</option><option>USDC (TRC20)</option><option>BTC</option><option>ETH</option><option>TON</option>
      </select>
      <input id="wdAddr" class="input" placeholder="Адрес получателя" style="min-width:260px">
      <input id="wdAmt" class="input" placeholder="Сумма" type="number" step="0.0001" style="width:120px">
      <button class="btn small" id="wdSend">Отправить заявку</button>
    </div>
    <div class="muted" style="margin-top:6px">Минимальный вывод: эквивалент 50 USDT. Комиссии как на Bybit (демо).</div>
    <div id="wdMsg" style="margin-top:8px"></div>
  </div>
</div>

<script>
const state = {
  logged: false,
  token: null,
  balances: { BTC:0.0142, ETH:1.18, BNB:4.2, SOL:12.5, TON:55, TRX:1200, USDT:640, USDC:0, XRP:280 },
  prices:   { BTC:65000, ETH:3400, BNB:580, LTC:75,  SOL:155, TON:6,  TRX:0.12, USDT:1,  USDC:1,  XRP:0.55 },
  equity: [], trades: [],
  simTimer: null, profile: 'balanced',
  tariffs: []
};
const $ = (id)=>document.getElementById(id);
const fmtUSD = v => '$' + Number(v).toLocaleString('en-US', {maximumFractionDigits:2});

// Тарифы
const tariffs = {
  conservative: { min: 100, max: 700, days: 10, yield: 0.13 },
  balanced:    { min: 3000, max: 9000, days: 25, yield: 0.21 },
  aggressive:  { min: 10000, max: 100000, days: 47, yield: 0.35 }
};

// ----- АВТОРИЗАЦИЯ -----
$('authLoginBtn').onclick = () => {
  const email = $('authEmail').value.trim();
  const pass = $('authPass').value.trim();
  if(email==='admin@example.com' && pass==='admin123') {
    state.logged = true; state.token = Math.random().toString(36).slice(2);
    $('authMsg').textContent = '';
    $('authPage').style.display = 'none';
    $('cabinetPage').style.display = '';
    $('mainHeader').style.display = 'none';
    $('mainHeaderShow').style.display = '';
    // Инициализация кабинета:
    renderBalances(); renderPrices(); if(state.equity.length===0) seedEquity(); drawChart(); renderKPIs(); renderTariffsList(); showTab('cabinet');
  } else {
    $('authMsg').textContent = 'Неверный email или пароль!';
  }
};
// ----- /АВТОРИЗАЦИЯ -----

// Вкладки
function showTab(tab) {
  $('tab-cabinet').classList.toggle('active', tab === 'cabinet');
  $('tab-my-tariffs').classList.toggle('active', tab === 'my-tariffs');
  $('page-cabinet2').style.display = tab === 'cabinet' ? '' : 'none';
  $('page-my-tariffs').style.display = tab === 'my-tariffs' ? '' : 'none';
}
$('tab-cabinet').onclick = ()=>showTab('cabinet');
$('tab-my-tariffs').onclick = ()=>{showTab('my-tariffs'); renderMyTariffsTable();};

// Запуск тарифа
$('startTariffBtn').onclick = () => {
  const type = $('tariffSelect').value;
  const deposit = +$('tariffDeposit').value;
  const trf = tariffs[type];
  if (!state.logged) { $('tariffMsg').textContent = 'Войдите в кабинет.'; return; }
  if (deposit < trf.min || deposit > trf.max) {
    $('tariffMsg').textContent = `Сумма должна быть от ${trf.min} до ${trf.max} USD для этого тарифа.`; return;
  }
  if (state.balances.USDT < deposit) {
    $('tariffMsg').textContent = 'Недостаточно средств на балансе.'; return;
  }
  state.balances.USDT -= deposit;
  const newTariff = {
    id: Math.random().toString(36).slice(2),
    type,
    deposit,
    start: Date.now(),
    end: Date.now() + trf.days * 24*3600*1000,
    targetYield: trf.yield,
    finished: false,
    profit: 0,
    tradesTimer: null,
    totalTrades: Math.round(trf.days * 5 * 24 * 60), // 5 сделок в минуту * 60 минут * X дней
    doneTrades: 0,
    trades: []
  };
  state.tariffs.push(newTariff);
  renderTariffsList();
  scheduleTariffTrades(newTariff);
  $('tariffMsg').textContent = 'Тариф запущен!';
};

// Список тарифов (в кабинете)
function renderTariffsList() {
  const list = state.tariffs.map(t => {
    const trf = tariffs[t.type];
    const daysLeft = t.finished ? 0 : Math.max(0, Math.ceil((t.end - Date.now()) / (24*3600*1000)));
    return `<div class="tag" style="margin-bottom:2px;">
      <b>${t.type}</b> | Сумма: $${t.deposit} | Доход: <b>$${t.profit.toFixed(2)}</b> | Доходность: ${Math.round(trf.yield*100)}% | 
      ${t.finished ? `<span class="pnl-pos">Завершён. Итог: $${(t.deposit + t.profit).toFixed(2)}</span>` : `Осталось: ${daysLeft}д`}
      </div>`;
  }).join('');
  $('tariffsList').innerHTML = list || '<span class="muted">Нет активных тарифов</span>';
  $('tariffsListSection').style.display = state.tariffs.length ? '' : 'none';
}

// Сделки и кривая капитала
function scheduleTariffTrades(tariff) {
  const trf = tariffs[tariff.type];
  const totalProfit = tariff.deposit * trf.yield;
  const avgPnl = totalProfit / tariff.totalTrades;
  tariff.doneTrades = 0;
  tariff.profit = 0;
  tariff.tradesTimer = setInterval(() => {
    if (tariff.finished) return;
    const std = avgPnl * 0.2;
    let pnl = avgPnl + (Math.random()-0.5)*std;
    if (tariff.doneTrades === tariff.totalTrades - 1) {
      pnl = totalProfit - tariff.profit;
    }
    tariff.profit += pnl;
    const tradeObj = {
      ts: Date.now(),
      symbol: 'BTC',
      side: Math.random() > .5 ? 'BUY' : 'SELL',
      qty: +(Math.random()*0.01).toFixed(4),
      price: state.prices['BTC'],
      pnl,
      tariffId: tariff.id,
      tariffType: tariff.type
    };
    tariff.trades.push(tradeObj);
    state.trades.unshift(tradeObj); // В общий список
    // Капитал: увеличиваем сразу по каждой сделке
    const last = state.equity.length
      ? state.equity[state.equity.length-1].e
      : 10000;
    state.equity.push({ts: tradeObj.ts, e: +(last + pnl).toFixed(2)});
    drawChart(); renderTrades(); renderKPIs();
    tariff.doneTrades++;
    if (tariff.doneTrades >= tariff.totalTrades || Date.now() > tariff.end) {
      finishTariff(tariff);
    }
    renderTariffsList();
    renderMyTariffsTable();
  }, 12000); // 5 сделок в минуту = 12 секунд
}

function finishTariff(tariff) {
  if (tariff.tradesTimer) clearInterval(tariff.tradesTimer);
  tariff.finished = true;
  state.balances.USDT += tariff.deposit + tariff.profit;
  renderBalances();
  renderTariffsList();
  renderMyTariffsTable();
}

// Обновление KPI
function renderBalances(){ $('balances').textContent = state.logged ? Object.entries(state.balances).map(([k,v])=>`${k}: ${v}`).join(' · ') : 'Войдите, чтобы увидеть баланс.'; }
function renderPrices(){ $('prices').textContent = Object.entries(state.prices).map(([k,v])=>`${k}: ${fmtUSD(v)}`).join(' · '); }
function renderKPIs(){
  const last = state.equity[state.equity.length-1]?.e || 10000;
  document.getElementById('kpiEquity').textContent = fmtUSD(last);
  const first30 = state.equity[Math.max(0, state.equity.length-30)]?.e || last;
  const pnl = last - first30;
  document.getElementById('kpiPnl').innerHTML = (pnl>=0?'<span class="pnl-pos">+':'<span class="pnl-neg">') + pnl.toFixed(2) + '</span>';
  document.getElementById('kpiTrades').textContent = state.trades.length;
}

// Стартовая генерация капитала
function seedEquity(){ let e = 10000; const pts=[]; for(let i=0;i<60;i++){ e += (Math.random()-.45)*25; pts.push({ts: Date.now()-(60-i)*3600000, e:+e.toFixed(2)});} state.equity = pts; }

// График капитала с метками сделок
function drawChart() {
  const cvs = document.getElementById('equityChart');
  const ctx = cvs.getContext('2d');
  const pad = 36, w = cvs.width - pad * 2, h = cvs.height - pad * 2;
  ctx.clearRect(0, 0, cvs.width, cvs.height);

  // Кривая капитала
  const ys = state.equity.map(p => p.e), minY = Math.min(...ys), maxY = Math.max(...ys);
  const sx = i => pad + (i * (w / (state.equity.length - 1)));
  const sy = v => pad + h - ((v - minY) / (maxY - minY)) * h;
  ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){ const y=pad+i*(h/4); ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+w,y); ctx.stroke(); }
  ctx.beginPath(); ctx.strokeStyle='#06b6d4'; ctx.lineWidth=2;
  state.equity.forEach((p, i) => { const x = sx(i), y = sy(p.e); i ? ctx.lineTo(x, y) : ctx.moveTo(x, y); });
  ctx.stroke();
  const g=ctx.createLinearGradient(0,pad,0,pad+h); g.addColorStop(0,'rgba(6,182,212,.35)'); g.addColorStop(1,'rgba(6,182,212,0)');
  ctx.lineTo(pad+w,pad+h); ctx.lineTo(pad,pad+h); ctx.closePath(); ctx.fillStyle=g; ctx.fill();
  ctx.fillStyle='#9ca3af'; ctx.font='12px sans-serif';
  ctx.fillText(fmtUSD(minY),6,pad+h); ctx.fillText(fmtUSD(maxY),6,pad+12);

  // Метки сделок (последние 100)
  const maxMarkers = 100;
  const tradesMarked = state.trades.slice(0, maxMarkers).reverse();
  tradesMarked.forEach((trade, i) => {
    const eqIdx = Math.max(0, state.equity.length - tradesMarked.length + i);
    const x = sx(eqIdx);
    const y = sy(state.equity[eqIdx]?.e || 10000);
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, 2 * Math.PI);
    ctx.fillStyle = trade.pnl >= 0 ? '#22c55e' : '#ef4444';
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.stroke();
    trade._chart_x = x;
    trade._chart_y = y;
  });
}

// Popup для сделок на графике
const popup = document.createElement('div');
popup.style.position = 'absolute'; popup.style.display = 'none';
popup.style.background = '#0f172a'; popup.style.color = '#e5e7eb';
popup.style.padding = '8px 14px'; popup.style.borderRadius = '10px';
popup.style.boxShadow = '0 2px 12px #0008'; popup.style.pointerEvents = 'none';
popup.style.zIndex = 50;
document.body.appendChild(popup);

$('equityChart').addEventListener('mousemove', (e) => {
  const rect = $('equityChart').getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  let found = null;
  state.trades.slice(0,100).reverse().forEach(trade => {
    if (trade._chart_x && trade._chart_y &&
      Math.abs(mx - trade._chart_x) < 8 && Math.abs(my - trade._chart_y) < 8) found = trade;
  });
  if (found) {
    const trf = state.tariffs.find(t=>t.id===found.tariffId);
    popup.innerHTML = `
      <b>${found.symbol}</b> ${found.side}<br>
      Объем: ${found.qty}<br>
      Цена: ${found.price}<br>
      P&L: <span style="color:${found.pnl>=0?'#22c55e':'#ef4444'}">${found.pnl>=0?'+':''}${found.pnl.toFixed(2)}</span><br>
      Тариф: <b>${found.tariffType || ''}</b>
    `;
    popup.style.left = (e.pageX + 10) + 'px';
    popup.style.top = (e.pageY - 30) + 'px';
    popup.style.display = '';
  } else {
    popup.style.display = 'none';
  }
});
$('equityChart').addEventListener('mouseleave', ()=>{ popup.style.display='none'; });

// Сделки таблица
function renderTrades(){
  const filt = document.getElementById('symbolFilter').value;
  const rows = (filt? state.trades.filter(t=>t.symbol===filt) : state.trades).slice(0,80).map(t=>{
    const cls = t.pnl>=0?'pnl-pos':'pnl-neg';
    return `<tr><td>${new Date(t.ts).toLocaleString()}</td><td>${t.symbol}</td><td>${t.side}</td><td>${t.qty}</td><td>${t.price}</td><td class="${cls}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</td></tr>`;
  }).join('');
  document.getElementById('trades').innerHTML = rows || `<tr><td colspan="6" class="muted">Сделок пока нет</td></tr>`;
}

// CSV
document.getElementById('exportCsv').onclick=()=>{
  const header=['time','symbol','side','qty','price','pnl','tariff'];
  const rows=state.trades.map(t=>[new Date(t.ts).toISOString(),t.symbol,t.side,t.qty,t.price,t.pnl,t.tariffType||'']);
  const csv=[header].concat(rows).map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='trades.csv'; a.click(); URL.revokeObjectURL(url);
};

// Модалки депозит/вывод
const modalDeposit=document.getElementById('modalDeposit'), modalWithdraw=document.getElementById('modalWithdraw');
const open=m=>m.classList.add('open'), close=m=>m.classList.remove('open');
document.querySelectorAll('[data-close="deposit"]').forEach(b=>b.onclick=()=>close(modalDeposit));
document.querySelectorAll('[data-close="withdraw"]').forEach(b=>b.onclick=()=>close(modalWithdraw));
document.getElementById('openDeposit').onclick = ()=> open(modalDeposit);
document.getElementById('openWithdraw').onclick= ()=> open(modalWithdraw);

document.getElementById('genAddr').onclick=()=>{
  const asset=document.getElementById('depAsset').value;
  const addr = asset.includes('TRC20') ? 'T'+Math.random().toString(36).slice(2,10).toUpperCase()+'...' :
              asset==='BTC' ? 'bc1q'+Math.random().toString(36).slice(2,9)+'...' :
              asset==='ETH' ? '0x'+Math.random().toString(16).slice(2,10)+'...' :
              'EQ'+Math.random().toString(36).slice(2,10).toUpperCase()+'...';
  document.getElementById('depInfo').innerHTML = `Адрес для ${asset}: <b>${addr}</b>`;
  const c=document.getElementById('qr'), ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  for(let y=0;y<22;y++) for(let x=0;x<22;x++){ const on=Math.random()>.5; ctx.fillStyle=on?'#e5e7eb':'#0b1220'; ctx.fillRect(10+x*9,10+y*9,8,8); }
  document.getElementById('qrBox').style.display='block';
};

document.getElementById('wdSend').onclick=()=>{
  const asset=document.getElementById('wdAsset').value, addr=document.getElementById('wdAddr').value.trim(), amt=+((document.getElementById('wdAmt').value)||0);
  if(!addr || !amt){ document.getElementById('wdMsg').innerHTML='<span class="pnl-neg">Заполните адрес и сумму.</span>'; return; }
  if((asset.includes('USDT')||asset.includes('USDC')) && amt<50){ document.getElementById('wdMsg').innerHTML='<span class="pnl-neg">Минимальный вывод — 50 USDT (экв.).</span>'; return; }
  document.getElementById('wdMsg').innerHTML='<span class="pnl-pos">Заявка создана: статус Pending (демо).</span>';
  setTimeout(()=>close(modalWithdraw), 1200);
};

// --- Вкладка "Мои тарифы" ---
function renderMyTariffsTable() {
  let tariffsRows = state.tariffs.map(t=>{
    const trf=tariffs[t.type];
    return `<tr>
      <td>${t.type}</td>
      <td>${t.deposit}</td>
      <td>${Math.round(trf.yield*100)}%</td>
      <td>${t.profit.toFixed(2)}</td>
      <td>${new Date(t.start).toLocaleDateString()}</td>
      <td>${new Date(t.end).toLocaleDateString()}</td>
      <td>${t.finished?'<span class="pnl-pos">Завершён</span>':'<span class="muted">В работе</span>'}</td>
    </tr>`;
  }).join('');
  $('myTariffsTable').innerHTML = tariffsRows || `<tr><td colspan="7" class="muted">Нет тарифов</td></tr>`;

  // Сделки по всем тарифам
  let dealsHtml = '';
  state.tariffs.forEach(tariff=>{
    dealsHtml += `<div style="margin-top:16px"><b>Тариф ${tariff.type}, сумма $${tariff.deposit} (${tariff.finished?'Завершён':'В работе'})</b></div>
      <table class="deal-list" style="width:100%"><thead>
        <tr><th>Время</th><th>Инстр.</th><th>Сторона</th><th>Кол-во</th><th>Цена</th><th>P&L ($)</th></tr>
      </thead><tbody>
        ${tariff.trades.slice(-20).reverse().map(trade=>{
          return `<tr>
            <td>${new Date(trade.ts).toLocaleString()}</td>
            <td>${trade.symbol}</td>
            <td>${trade.side}</td>
            <td>${trade.qty}</td>
            <td>${trade.price}</td>
            <td class="${trade.pnl>=0?'deal-pnl-pos':'deal-pnl-neg'}">${trade.pnl>=0?'+':''}${trade.pnl.toFixed(2)}</td>
          </tr>`;
        }).join('')}
      </tbody></table>`;
  });
  $('myTariffsDeals').innerHTML = dealsHtml || '<div class="muted" style="margin-top:12px">Пока нет сделок по тарифам</div>';
}

// Инициализация
seedEquity();
showTab('cabinet');

setInterval(()=>{
  drawChart(); renderTariffsList(); renderMyTariffsTable();
}, 60000); // обновляем раз в минуту таймеры и график
</script>
</body>
</html>
