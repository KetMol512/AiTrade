<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BoostEx Trade — Кабинет</title>
  <style>
    body {
      margin:0; background:linear-gradient(120deg,#0b1220 0%,#06b6d4 100%);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#e5e7eb;
      min-height:100vh;
    }
    #app-center {
      display:flex;align-items:center;justify-content:center;min-height:100vh;
    }
    .auth-card {
      background:rgba(15,23,42,.98);
      box-shadow:0 10px 30px #0008;
      border-radius:24px;
      padding:40px 32px 32px 32px;
      min-width:340px;
      max-width:95vw;
      display:flex;flex-direction:column;align-items:center;
      margin-top:-60px;
    }
    h1 {
      font-size:2rem;font-weight:700;margin-bottom:10px;letter-spacing:1px;
      text-shadow:0 2px 14px #06b6d4a0;
    }
    .tab-row {
      display:flex;gap:10px;margin-bottom:16px;
    }
    .tab-btn {
      background:transparent;
      color:#06b6d4;
      border:none;
      font-weight:700;
      font-size:15px;
      padding:7px 18px;
      border-radius:8px;
      cursor:pointer;
      transition:.2s;
      border:2px solid transparent;
    }
    .tab-btn.active {
      background:#06b6d4;
      color:#18324b;
      border:2px solid #09d6f8;
      box-shadow:0 2px 16px #06b6d4b0;
    }
    .form-row {
      display:flex;flex-direction:column;gap:15px;width:100%;margin-bottom:18px;
    }
    .input {
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid #1f2937;
      border-radius:10px;
      padding:11px 14px;
      outline:none;
      font-size:15px;
      transition:.2s;
    }
    .input:focus {
      border-color:#06b6d4;
      box-shadow:0 0 0 2px #06b6d430;
    }
    .btn {
      background:#06b6d4;
      color:#0b1220;
      border:none;
      border-radius:10px;
      padding:11px 26px;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 2px 10px #06b6d480;
      transition:.2s;
    }
    .btn:active {background:#09d6f8;}
    .msg {
      margin-top:12px;
      min-height:22px;
      color:#ef4444;
      font-size:15px;
      text-align:center;
    }
    .muted {
      color:#9ca3af;font-size:14px;text-align:center;margin-top:8px;
    }
    /* Кабинет */
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg,rgba(11,18,32,.8),rgba(11,18,32,.5)); backdrop-filter: blur(8px); border-bottom:1px solid #1f2937}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .right{margin-left:auto}
    .card{background:linear-gradient(180deg,#0f172a,#0c1528); border:1px solid #1f2937; border-radius:14px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.2)}
    .h1{font-weight:700; font-size:18px}
    .h2{font-weight:600; font-size:16px}
    .btn.small{padding:8px 10px; font-weight:600; border-radius:8px}
    .btn.ghost{background:transparent; color:#e5e7eb; border:1px solid #1f2937}
    .input, .select{background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px; padding:10px 12px; outline:none}
    .input:focus, .select:focus{border-color:#1e40af; box-shadow: 0 0 0 3px rgba(30,64,175,.35)}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    .kpi{background:#0c1528; border:1px solid #1f2937; border-radius:12px; padding:12px}
    .kpi .val{font-size:22px; font-weight:800}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{padding:10px; border-bottom:1px solid #1f2937; text-align:left}
    .pnl-pos{color:#22c55e} .pnl-neg{color:#ef4444}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #1f2937; border-radius:999px; background:#0b1220; color:#cbd5e1}
    .canvas-wrap{background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:10px}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:30}
    .modal.open{display:flex}
    .sheet{background:linear-gradient(180deg,#101a2e,#0d1628); border:1px solid #1f2937; border-radius:16px; padding:18px; width:min(520px,92vw)}
    #toastBox {position:fixed;top:30px;right:30px;z-index:100;}
    .toast {background:#222;border-radius:8px;color:#fff;padding:12px 20px;margin-bottom:10px;box-shadow:0 2px 12px #0002;opacity:0;transition:.3s;}
    .toast.info {background:#06b6d4;}
    .toast.success {background:#22c55e;}
    .toast.error {background:#ef4444;}
    @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} .grid2{grid-template-columns:1fr} }
    @media(max-width:480px){
      .wrap{padding:8px;}
      .card{padding:8px;}
    }
  </style>
</head>
<body>
<div id="app-center"></div>
<div id="app-cabinet" style="display:none">
<header>
  <div class="wrap row">
    <div class="h1">BoostEx — торговый кабинет</div>
    <div class="row right">
      <button class="btn small" id="openDeposit">Депозит</button>
      <button class="btn small ghost" id="openWithdraw">Вывод</button>
      <button class="btn small ghost" id="openHistory">История операций</button>
      <button class="btn small ghost" id="logoutBtn">Выйти</button>
    </div>
  </div>
</header>
<main class="wrap" id="cabinetMain">
  <section class="card">
    <div class="row">
      <div class="h2">Выбор тарифа</div>
    </div>
    <div class="row" style="margin-top:10px">
      <select id="tariffSelect" class="select">
        <option value="conservative">Начальный: $100–$700, 13% за 10 дней</option>
        <option value="balanced">Средний: $3000–$9000, 21% за 25 дней</option>
        <option value="aggressive">Максимальный: $10,000–$100,000, 35% за 47 дней</option>
      </select>
      <input id="tariffDeposit" class="input" type="number" placeholder="Сумма ($)" style="width:140px">
      <button class="btn" id="startTariffBtn">Запустить тариф</button>
    </div>
    <div id="tariffMsg" class="muted" style="margin-top:10px"></div>
  </section>
  <section class="card" id="activeTariffSection" style="display:none">
    <div class="h2">Активный тариф</div>
    <div id="activeTariffInfo" class="muted" style="margin-top:8px"></div>
    <div id="tariffTimer" style="margin-top:6px"></div>
  </section>
  <section class="kpis">
    <div class="kpi"><div class="muted">Баланс (USD)</div><div class="val" id="kpiEquity">$—</div></div>
    <div class="kpi"><div class="muted">Доход (30д)</div><div class="val" id="kpiPnl">—</div></div>
    <div class="kpi"><div class="muted">Сделки</div><div class="val" id="kpiTrades">—</div></div>
    <div class="kpi"><div class="muted">Статус</div><div class="val" id="kpiStatus">Онлайн</div></div>
  </section>
  <section class="grid2">
    <div class="card">
      <div class="h2">Балансы</div>
      <div id="balances" class="muted" style="margin-top:6px">Войдите, чтобы увидеть баланс.</div>
    </div>
    <div class="card">
      <div class="h2">Курсы (USD) — топ-10</div>
      <div id="prices" class="muted" style="margin-top:6px">—</div>
    </div>
  </section>
  <section class="card">
    <div class="row">
      <div class="h2">Кривая капитала</div>
      <div class="right row">
        <select id="profile" class="select">
          <option value="conservative">Conservative (15–25%/м)</option>
          <option value="balanced" selected>Balanced (25–35%/м)</option>
          <option value="aggressive">Aggressive (35–45%/м)</option>
        </select>
        <button class="btn small" id="startSim">Старт</button>
        <button class="btn small ghost" id="stopSim">Пауза</button>
        <button class="btn small ghost" id="resetSim">Сброс</button>
      </div>
    </div>
    <div class="canvas-wrap" style="margin-top:10px"><canvas id="equityChart" width="1000" height="280"></canvas></div>
  </section>
  <section class="card">
    <div class="row">
      <div class="h2">Сделки (последние)</div>
      <div class="right row">
        <select id="symbolFilter" class="select">
          <option value="">Все инструменты</option>
          <option>BTC</option><option>ETH</option><option>BNB</option><option>SOL</option><option>TON</option>
        </select>
        <button class="btn small ghost" id="exportCsv">Экспорт CSV</button>
      </div>
    </div>
    <table class="table" style="margin-top:6px">
      <thead><tr><th>Время</th><th>Инструмент</th><th>Сторона</th><th>Кол-во</th><th>Цена</th><th>P&L ($)</th></tr></thead>
      <tbody id="trades"></tbody>
    </table>
  </section>
</main>
<div class="modal" id="modalHistory">
  <div class="sheet">
    <div class="row"><div class="h2">История операций</div><button class="btn small ghost right" data-close="history">Закрыть</button></div>
    <div id="historyContent" style="margin-top:10px"></div>
  </div>
</div>
<div class="modal" id="modalDeposit">
  <div class="sheet">
    <div class="row"><div class="h2">Депозит</div><button class="btn small ghost right" data-close="deposit">Закрыть</button></div>
    <div class="row" style="margin-top:10px">
      <select id="depAsset" class="select">
        <option>USDT (TRC20)</option><option>USDC (TRC20)</option><option>BTC</option><option>ETH</option><option>TON</option>
      </select>
      <button class="btn small" id="genAddr">Сгенерировать адрес</button>
    </div>
    <div id="depInfo" class="muted" style="margin-top:10px">Выберите актив и сгенерируйте адрес пополнения.</div>
    <div id="qrBox" class="card" style="margin-top:10px; display:none">
      <div class="muted">QR-код (псевдо)</div>
      <canvas id="qr" width="220" height="220" style="margin-top:8px; background:#0b1220; border:1px solid #1f2937; border-radius:10px"></canvas>
    </div>
  </div>
</div>
<div class="modal" id="modalWithdraw">
  <div class="sheet">
    <div class="row"><div class="h2">Вывод средств</div><button class="btn small ghost right" data-close="withdraw">Закрыть</button></div>
    <div class="row" style="margin-top:10px">
      <select id="wdAsset" class="select">
        <option>USDT (TRC20)</option><option>USDC (TRC20)</option><option>BTC</option><option>ETH</option><option>TON</option>
      </select>
      <input id="wdAddr" class="input" placeholder="Адрес получателя" style="min-width:260px">
      <input id="wdAmt" class="input" placeholder="Сумма" type="number" step="0.0001" style="width:120px">
      <button class="btn small" id="wdSend">Отправить заявку</button>
    </div>
    <div class="muted" style="margin-top:6px">Минимальный вывод: эквивалент 50 USDT. Комиссии как на Bybit.</div>
    <div id="wdMsg" style="margin-top:8px"></div>
  </div>
</div>
<div id="toastBox"></div>
</div>
<script>
const API_URL = "https://yourserver.com/api"; // замените на свой бэкенд-адрес

const $ = id => document.getElementById(id);

function showCabinet() {
  $('app-center').style.display = 'none';
  $('app-cabinet').style.display = '';
}
function showAuth() {
  $('app-cabinet').style.display = 'none';
  $('app-center').style.display = 'flex';
}

function renderAuthForm() {
  $('app-center').innerHTML = `
    <div class="auth-card">
      <h1>BoostEx Trade</h1>
      <div class="tab-row">
        <button class="tab-btn active" id="tabLogin">Вход</button>
        <button class="tab-btn" id="tabReg">Регистрация</button>
      </div>
      <form id="loginForm">
        <div class="form-row" id="loginFields">
          <input class="input" id="loginEmail" type="email" placeholder="Email" autocomplete="username" />
          <input class="input" id="loginPass" type="password" placeholder="Пароль" autocomplete="current-password" />
        </div>
        <button type="submit" class="btn" id="loginBtn">Войти</button>
        <div class="msg" id="loginMsg"></div>
      </form>
      <form id="regForm" style="display:none">
        <div class="form-row" id="regFields">
          <input class="input" id="regEmail" type="email" placeholder="Email" autocomplete="username" />
          <input class="input" id="regPass" type="password" placeholder="Пароль" autocomplete="new-password" />
          <input class="input" id="regPass2" type="password" placeholder="Повторите пароль" autocomplete="new-password" />
        </div>
        <button type="submit" class="btn" id="regBtn">Зарегистрироваться</button>
        <div class="msg" id="regMsg"></div>
      </form>
      <div class="muted">Данные защищены. Платформа не хранит приватные ключи и пароли в открытом виде.</div>
    </div>
  `;
  $('tabLogin').onclick = () => {
    $('tabLogin').classList.add('active'); $('tabReg').classList.remove('active');
    $('loginForm').style.display = ''; $('regForm').style.display = 'none';
  };
  $('tabReg').onclick = () => {
    $('tabReg').classList.add('active'); $('tabLogin').classList.remove('active');
    $('loginForm').style.display = 'none'; $('regForm').style.display = '';
  };
  $('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    const email = $('loginEmail').value.trim();
    const pass = $('loginPass').value.trim();
    $('loginMsg').textContent = '';
    if(!email || !pass){ $('loginMsg').textContent = 'Введите email и пароль.'; return; }
    $('loginBtn').disabled = true;
    try {
      const resp = await fetch(API_URL+"/login", {
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({email, pass})
      });
      const data = await resp.json();
      if(data.token){
        localStorage.setItem('token', data.token);
        showCabinet();
        await refreshAll();
      } else {
        $('loginMsg').textContent = data.error || "Ошибка авторизации";
      }
    } catch(e){
      $('loginMsg').textContent = "Ошибка соединения";
    }
    $('loginBtn').disabled = false;
  };
  $('regForm').onsubmit = async (e) => {
    e.preventDefault();
    const email = $('regEmail').value.trim();
    const pass = $('regPass').value.trim();
    const pass2 = $('regPass2').value.trim();
    $('regMsg').textContent = '';
    if(!email || !pass || !pass2){ $('regMsg').textContent = 'Заполните все поля.'; return; }
    if(pass !== pass2){ $('regMsg').textContent = 'Пароли не совпадают.'; return; }
    if(pass.length < 6){ $('regMsg').textContent = 'Пароль минимум 6 символов.'; return; }
    $('regBtn').disabled = true;
    try {
      const resp = await fetch(API_URL+"/register", {
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({email, pass})
      });
      const data = await resp.json();
      if(data.success){
        $('regMsg').style.color = "#22c55e";
        $('regMsg').textContent = "Регистрация успешна! Теперь войдите.";
        setTimeout(()=>{$('tabLogin').click()}, 1500);
      } else {
        $('regMsg').textContent = data.error || "Ошибка регистрации";
      }
    } catch(e){
      $('regMsg').textContent = "Ошибка соединения";
    }
    $('regBtn').disabled = false;
  };
}

function logout() {
  localStorage.removeItem('token');
  showAuth();
  renderAuthForm();
}

const state = {
  logged: false,
  token: null,
  balances: {},
  prices: {},
  equity: [], trades: [], simTimer: null, profile: 'balanced',
  tariff: null, history: []
};
const fmtUSD = v => '$' + Number(v).toLocaleString('en-US', {maximumFractionDigits:2});

function showToast(msg, type='info', timeout=2200){
  const box = $('toastBox');
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.innerHTML = msg;
  box.appendChild(el);
  setTimeout(()=>el.style.opacity='1', 50);
  setTimeout(()=>{
    el.style.opacity='0';
    setTimeout(()=>box.removeChild(el), 300);
  }, timeout);
}
function logHistory(type, details){
  state.history.unshift({type, details, ts: Date.now()});
  renderHistory();
}
$('openHistory').onclick = ()=> open($('modalHistory'));
document.querySelectorAll('[data-close="history"]').forEach(b=>b.onclick=()=>close($('modalHistory')));
function renderHistory(){
  $('historyContent').innerHTML = state.history.length
    ? state.history.map(h=>`<div>${new Date(h.ts).toLocaleString()} — <b>${h.type}</b>: ${h.details}</div>`).join('')
    : '<div class="muted">Пусто</div>';
}
async function apiGetBalances(token){
  const r = await fetch(API_URL+"/balances", { headers:{"Authorization":"Bearer "+token} });
  if(!r.ok) return {};
  return await r.json();
}
async function apiGetPrices(){
  const r = await fetch(API_URL+"/prices");
  if(!r.ok) return {};
  return await r.json();
}
async function apiStartTariff(token, type, deposit){
  const r = await fetch(API_URL+"/tariff/start", {
    method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
    body:JSON.stringify({type, deposit})
  });
  return r.ok ? await r.json() : null;
}
async function apiGetTariff(token){
  const r = await fetch(API_URL+"/tariff", { headers:{"Authorization":"Bearer "+token} });
  return r.ok ? await r.json() : null;
}
async function apiWithdraw(token, asset, addr, amt){
  const r = await fetch(API_URL+"/withdraw", {
    method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
    body:JSON.stringify({asset, addr, amt})
  });
  return r.ok ? await r.json() : null;
}
$('startTariffBtn').onclick = async () => {
  const type = $('tariffSelect').value;
  const deposit = +$('tariffDeposit').value;
  if (!state.logged) { $('tariffMsg').textContent = 'Войдите в кабинет.'; return; }
  showToast('Запуск тарифа...', 'info');
  const resp = await apiStartTariff(state.token, type, deposit);
  if(resp && resp.success){
    $('tariffMsg').textContent = '';
    logHistory('Тариф', `Запущен ${type} с депозитом $${deposit}`);
    showToast('Тариф запущен!', 'success');
    await refreshTariff();
    await refreshBalances();
  } else {
    $('tariffMsg').textContent = resp?.error || 'Ошибка запуска тарифа';
    showToast('Ошибка тарифа', 'error');
  }
};
async function refreshTariff(){
  if(!state.logged) return;
  const tariff = await apiGetTariff(state.token);
  state.tariff = tariff;
  if(tariff && tariff.active){
    $('activeTariffSection').style.display = '';
    updateActiveTariffInfo();
  } else {
    $('activeTariffSection').style.display = 'none';
  }
}
function updateActiveTariffInfo() {
  if (!state.tariff) return;
  const trf = state.tariff;
  $('activeTariffInfo').innerHTML =
    `Тариф: <b>${trf.type}</b><br>Сумма: <b>$${trf.deposit}</b><br>
    Доходность: <b>${Math.round(trf.targetYield*100)}%</b> за ${trf.days} дней<br>
    Осталось дней: <b>${trf.daysLeft}</b>`;
  if (trf.finished) {
    $('tariffTimer').innerHTML = `<span class="pnl-pos">Тариф завершён! На баланс вернулось $${(trf.deposit + trf.profit).toFixed(2)}</span>`;
  } else {
    $('tariffTimer').innerHTML = `До завершения: <b>${formatTimer(trf.msLeft)}</b>`;
  }
}
function formatTimer(ms) {
  if (ms<=0) return '00:00:00';
  const d = Math.floor(ms/(24*3600*1000));
  const h = Math.floor((ms%(24*3600*1000))/3600000);
  const m = Math.floor((ms%3600000)/60000);
  return `${d}д ${h}ч ${m}м`;
}
async function refreshBalances(){
  if(!state.logged) return $('balances').textContent = 'Войдите, чтобы увидеть баланс.';
  const balances = await apiGetBalances(state.token);
  state.balances = balances;
  $('balances').textContent = Object.entries(state.balances).map(([k,v])=>`${k}: ${v}`).join(' · ');
  renderKPIs();
}
async function refreshPrices(){
  const prices = await apiGetPrices();
  state.prices = prices;
  $('prices').textContent = Object.entries(state.prices).map(([k,v])=>`${k}: ${fmtUSD(v)}`).join(' · ');
}
function renderKPIs(){
  const last = state.tariff?.equity || 10000;
  $('kpiEquity').textContent = fmtUSD(last);
  const pnl = state.tariff?.profit || 0;
  $('kpiPnl').innerHTML = (pnl>=0?'<span class="pnl-pos">+':'<span class="pnl-neg">') + pnl.toFixed(2) + '</span>';
  $('kpiTrades').textContent = state.tariff?.doneTrades || 0;
  $('kpiStatus').textContent = state.logged ? "Онлайн" : "Оффлайн";
  if (state.tariff) updateActiveTariffInfo();
}
function renderTrades(){
  const filt = $('symbolFilter').value;
  const rows = (filt? state.trades.filter(t=>t.symbol===filt) : state.trades).slice(0,80).map(t=>{
    const cls = t.pnl>=0?'pnl-pos':'pnl-neg';
    return `<tr><td>${new Date(t.ts).toLocaleString()}</td><td>${t.symbol}</td><td>${t.side}</td><td>${t.qty}</td><td>${t.price}</td><td class="${cls}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</td></tr>`;
  }).join('');
  $('trades').innerHTML = rows || `<tr><td colspan="6" class="muted">Сделок пока нет</td></tr>`;
}
const open=m=>m.classList.add('open'), close=m=>m.classList.remove('open');
document.querySelectorAll('[data-close="deposit"]').forEach(b=>b.onclick=()=>close($('modalDeposit')));
document.querySelectorAll('[data-close="withdraw"]').forEach(b=>b.onclick=()=>close($('modalWithdraw'));
$('openDeposit').onclick = ()=> open($('modalDeposit'));
$('openWithdraw').onclick= ()=> open($('modalWithdraw'));
$('genAddr').onclick=()=>{
  const asset=$('depAsset').value;
  const addr = asset.includes('TRC20') ? 'T'+Math.random().toString(36).slice(2,10).toUpperCase()+'...' :
              asset==='BTC' ? 'bc1q'+Math.random().toString(36).slice(2,9)+'...' :
              asset==='ETH' ? '0x'+Math.random().toString(16).slice(2,10)+'...' :
              'EQ'+Math.random().toString(36).slice(2,10).toUpperCase()+'...';
  $('depInfo').innerHTML = `Адрес для ${asset}: <b>${addr}</b>`;
  const c=$('qr'), ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  for(let y=0;y<22;y++) for(let x=0;x<22;x++){ const on=Math.random()>.5; ctx.fillStyle=on?'#e5e7eb':'#0b1220'; ctx.fillRect(10+x*9,10+y*9,8,8); }
  $('qrBox').style.display='block';
  logHistory('Депозит', `Сгенерирован адрес для ${asset}`);
  showToast('Адрес сгенерирован', 'info');
};
$('wdSend').onclick=async()=>{
  const asset=$('wdAsset').value, addr=$('wdAddr').value.trim(), amt=+($('wdAmt').value||0);
  if(!addr || !amt){ $('wdMsg').innerHTML='<span class="pnl-neg">Заполните адрес и сумму.</span>'; return; }
  if((asset.includes('USDT')||asset.includes('USDC')) && amt<50){ $('wdMsg').innerHTML='<span class="pnl-neg">Минимальный вывод — 50 USDT (экв.).</span>'; return; }
  showToast('Отправка заявки...', 'info');
  const resp = await apiWithdraw(state.token, asset, addr, amt);
  if(resp && resp.success){
    $('wdMsg').innerHTML='<span class="pnl-pos">Заявка создана: статус Pending.</span>';
    logHistory('Вывод', `${asset} на ${addr}, сумма ${amt}`);
    showToast('Заявка отправлена!', 'success');
    setTimeout(()=>close($('modalWithdraw')), 1200);
    await refreshBalances();
  } else {
    $('wdMsg').innerHTML='<span class="pnl-neg">Ошибка: '+(resp?.error||'Не удалось отправить заявку')+'</span>';
    showToast('Ошибка вывода', 'error');
  }
};
$('exportCsv').onclick=()=>{
  const header=['time','symbol','side','qty','price','pnl'];
  const rows=state.trades.map(t=>[new Date(t.ts).toISOString(),t.symbol,t.side,t.qty,t.price,t.pnl]);
  const csv=[header].concat(rows).map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='trades.csv'; a.click(); URL.revokeObjectURL(url);
};
function seedEquity(){ let e = 10000; const pts=[]; for(let i=0;i<60;i++){ e += (Math.random()-.45)*25; pts.push({ts: Date.now()-(60-i)*3600000, e:+e.toFixed(2)});} state.equity = pts; }
function drawChart(){
  const cvs = $('equityChart'), ctx = cvs.getContext('2d');
  const pad=36, w=cvs.width-pad*2, h=cvs.height-pad*2;
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const ys = state.equity.map(p=>p.e), minY=Math.min(...ys), maxY=Math.max(...ys);
  const sx=i=>pad+(i*(w/(state.equity.length-1))), sy=v=>pad+h-((v-minY)/(maxY-minY))*h;
  ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){ const y=pad+i*(h/4); ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+w,y); ctx.stroke(); }
  ctx.beginPath(); ctx.strokeStyle='#06b6d4'; ctx.lineWidth=2;
  state.equity.forEach((p,i)=>{ const x=sx(i), y=sy(p.e); i?ctx.lineTo(x,y):ctx.moveTo(x,y); }); ctx.stroke();
  const g=ctx.createLinearGradient(0,pad,0,pad+h); g.addColorStop(0,'rgba(6,182,212,.35)'); g.addColorStop(1,'rgba(6,182,212,0)');
  ctx.lineTo(pad+w,pad+h); ctx.lineTo(pad,pad+h); ctx.closePath(); ctx.fillStyle=g; ctx.fill();
  ctx.fillStyle='#9ca3af'; ctx.font='12px sans-serif'; ctx.fillText(fmtUSD(minY),6,pad+h); ctx.fillText(fmtUSD(maxY),6,pad+12);
}
function profileRange(p){ if(p==='conservative')return[-8,12]; if(p==='aggressive')return[-20,30]; return[-12,18]; }
function tick(){
  const syms=['BTC','ETH','BNB','SOL','TON']; const sym=syms[Math.floor(Math.random()*syms.length)];
  const side=Math.random()>.5?'BUY':'SELL'; const qty=+(Math.random()*(sym==='BTC'?0.005:sym==='ETH'?0.1:20)).toFixed(4);
  const price=+(state.prices[sym]*(0.98+Math.random()*0.04)).toFixed(2);
  const [minP,maxP]=profileRange(state.profile); const pnl=+((Math.random()*(maxP-minP)+minP)).toFixed(2);
  state.trades.unshift({ts: Date.now(), symbol:sym, side, qty, price, pnl});
  if(state.trades.length>200) state.trades.pop();
  const last = state.equity[state.equity.length-1]?.e || 10000;
  state.equity.push({ts: Date.now(), e: +(last + pnl).toFixed(2)});
  if(state.equity.length>240) state.equity.shift();
  drawChart(); renderTrades(); renderKPIs();
}
$('startSim').onclick=()=>{ if(state.simTimer) return; state.simTimer=setInterval(tick, 1200); };
$('stopSim').onclick =()=>{ clearInterval(state.simTimer); state.simTimer=null; };
$('resetSim').onclick=()=>{ state.trades=[]; seedEquity(); drawChart(); renderTrades(); renderKPIs(); };
$('profile').onchange=(e)=>{ state.profile=e.target.value; };
$('logoutBtn').onclick = logout;
async function refreshAll(){
  state.token = localStorage.getItem('token');
  state.logged = !!state.token;
  if(!state.logged) { showAuth(); renderAuthForm(); return; }
  showCabinet();
  await refreshBalances();
  await refreshPrices();
  await refreshTariff();
  renderTrades();
  seedEquity();
  drawChart();
  renderHistory();
  renderKPIs();
}
window.onload = () => {
  if(localStorage.getItem('token')) {
    showCabinet();
    refreshAll();
  } else {
    showAuth();
    renderAuthForm();
  }
};
setInterval(updateActiveTariffInfo, 60000);
</script>
</body>
</html>
