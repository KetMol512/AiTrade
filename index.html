<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Trading Bot</title>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e17;
      --card: #111722;
      --text: #d1d4dc;
      --green: #00d4aa;
      --red: #ff5252;
      --yellow: #ffd700;
      --border: #1a2a3a;
      --hover: #1e2a38;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; min-height: 100vh; }

    /* === АВТОРИЗАЦИЯ === */
    #authPage {
      display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;
    }
    .auth-box {
      background: var(--card); padding: 40px; border-radius: 16px; width: 100%; max-width: 420px;
      border: 1px solid var(--border); text-align: center; box-shadow: 0 12px 32px rgba(0,0,0,0.4);
    }
    .logo { font-size: 2.5rem; font-weight: 700; color: var(--green); margin-bottom: 16px; }
    h2 { margin-bottom: 24px; color: #fff; font-size: 1.5rem; }
    input {
      width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px;
      background: #0a0e17; border: 1px solid var(--border); color: var(--text);
      font-size: 1rem; transition: all 0.2s;
    }
    input:focus { outline: none; border-color: var(--green); box-shadow: 0 0 0 2px rgba(0,212,170,0.2); }
    button {
      width: 100%; padding: 14px; margin-top: 16px; background: var(--green);
      color: #000; border: none; border-radius: 10px; font-weight: 600;
      cursor: pointer; font-size: 1.1rem; transition: all 0.2s;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,212,170,0.3); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .switch { margin-top: 20px; color: #888; font-size: 0.95rem; }
    .switch a { color: var(--green); cursor: pointer; text-decoration: underline; }

    /* === ТАРИФЫ === */
    .tariffs { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 20px 0; }
    .tariff-card {
      background: var(--card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); text-align: center;
      transition: all 0.2s;
    }
    .tariff-card:hover { border-color: var(--green); transform: translateY(-2px); }
    .tariff-name { font-size: 1.4rem; font-weight: 700; color: var(--green); margin-bottom: 10px; }
    .tariff-price { font-size: 2rem; font-weight: 700; color: var(--yellow); margin-bottom: 10px; }
    .tariff-duration { color: #888; margin-bottom: 15px; }
    .tariff-features { list-style: none; margin-bottom: 20px; text-align: left; }
    .tariff-features li { padding: 5px 0; color: var(--text); }
    .buy-btn { background: var(--green); color: #000; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; }
    .buy-btn:hover { background: #00b894; }

    /* === ТОРГОВЫЙ ТЕРМИНАЛ === */
    #dashboard { display: none; }
    .container { max-width: 1500px; margin: 0 auto; padding: 16px; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 0; border-bottom: 1px solid var(--border);
    }
    .user-info { font-size: 0.9rem; color: #aaa; }
    .logout { background: var(--red); color: #fff; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 12px; font-size: 0.85rem; transition: 0.2s; }
    .logout:hover { background: #cc4141; }

    .main { display: grid; grid-template-columns: 1fr 360px; gap: 16px; margin-top: 16px; }
    #chart { height: 580px; border-radius: 14px; overflow: hidden; background: var(--card); border: 1px solid var(--border); }

    .sidebar { display: flex; flex-direction: column; gap: 16px; }
    .card {
      background: var(--card); border-radius: 14px; padding: 18px; border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .card:hover { border-color: var(--green); }
    .card h3 { margin-bottom: 14px; color: var(--green); font-size: 1.05rem; font-weight: 600; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px; }
    .controls button {
      background: var(--hover); color: var(--text); border: none;
      padding: 10px 16px; border-radius: 10px; cursor: pointer; font-size: 0.9rem;
      transition: all 0.2s; flex: 1;
    }
    .controls button.active { background: var(--green); color: #000; font-weight: 600; }

    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat { background: rgba(0,212,170,0.1); padding: 12px; border-radius: 10px; text-align: center; font-size: 0.9rem; }
    .stat span { display: block; font-weight: 600; font-size: 1.2rem; margin-top: 4px; color: var(--green); }

    .trades { max-height: 220px; overflow-y: auto; font-size: 0.85rem; }
    .trade { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .trade.buy { color: var(--green); }
    .trade.sell { color: var(--red); }

    .info-bar { margin-top: 16px; font-size: 0.9rem; color: #888; display: flex; justify-content: space-between; }

    @media (max-width: 968px) { .main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<!-- === СТРАНИЦА АВТОРИЗАЦИИ === -->
<div id="authPage">
  <div class="auth-box">
    <div class="logo">AI Bot</div>
    <h2 id="authTitle">Вход</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Пароль" />
    <input type="password" id="confirmPassword" placeholder="Подтвердите пароль" style="display:none;" />
    <button id="authBtn">Войти</button>
    <div class="switch">
      <span id="switchText">Нет аккаунта? </span>
      <a id="switchLink">Зарегистрироваться</a>
    </div>
  </div>
</div>

<!-- === СТРАНИЦА ТАРИФОВ === -->
<div id="plansPage" style="display: none;">
  <div class="container">
    <div class="header">
      <div class="logo">AI Trading Bot</div>
      <div>
        <span class="user-info" id="usernameDisplay">Пользователь</span>
        <span class="logout" id="logout">Выйти</span>
      </div>
    </div>
    <h2 style="text-align: center; margin: 40px 0 20px; color: #fff;">Выберите тариф</h2>
    <div class="tariffs">
      <div class="tariff-card">
        <div class="tariff-name">Starter</div>
        <div class="tariff-price">$49</div>
        <div class="tariff-duration">1 месяц</div>
        <ul class="tariff-features">
          <li>Порог входа: $100</li>
          <li>Базовые пары (BTC, ETH)</li>
          <li>EMA стратегия</li>
          <li>Поддержка 24/7</li>
        </ul>
        <button class="buy-btn" onclick="buyPlan('starter', 'BTC')">Купить</button>
      </div>
      <div class="tariff-card">
        <div class="tariff-name">Basic</div>
        <div class="tariff-price">$99</div>
        <div class="tariff-duration">3 месяца</div>
        <ul class="tariff-features">
          <li>Порог входа: $500</li>
          <li>Топ-10 пар (BNB, SOL, XRP)</li>
          <li>EMA + RSI</li>
          <li>Аналитика</li>
        </ul>
        <button class="buy-btn" onclick="buyPlan('basic', 'ETH')">Купить</button>
      </div>
      <div class="tariff-card">
        <div class="tariff-name">Pro</div>
        <div class="tariff-price">$199</div>
        <div class="tariff-duration">6 месяцев</div>
        <ul class="tariff-features">
          <li>Порог входа: $1,000</li>
          <li>Топ-20 пар (DOGE, ADA, TRX)</li>
          <li>Гибрид стратегия</li>
          <li>Приоритет поддержка</li>
        </ul>
        <button class="buy-btn" onclick="buyPlan('pro', 'SOL')">Купить</button>
      </div>
      <div class="tariff-card">
        <div class="tariff-name">Premium</div>
        <div class="tariff-price">$399</div>
        <div class="tariff-duration">12 месяцев</div>
        <ul class="tariff-features">
          <li>Порог входа: $5,000</li>
          <li>Топ-30 пар (LINK, TON, AVAX)</li>
          <li>AI оптимизация</li>
          <li>Персональный менеджер</li>
        </ul>
        <button class="buy-btn" onclick="buyPlan('premium', 'BNB')">Купить</button>
      </div>
      <div class="tariff-card">
        <div class="tariff-name">Elite</div>
        <div class="tariff-price">$999</div>
        <div class="tariff-duration">24 месяца</div>
        <ul class="tariff-features">
          <li>Порог входа: $10,000</li>
          <li>Все топ-30 пары</li>
          <li>Полный AI + кастом</li>
          <li>VIP доступ</li>
        </ul>
        <button class="buy-btn" onclick="buyPlan('elite', 'XRP')">Купить</button>
      </div>
    </div>
  </div>
</div>

<!-- === ТОРГОВЫЙ ТЕРМИНАЛ === -->
<div id="dashboard">
  <div class="container">
    <div class="header">
      <div class="logo">AI Trading Bot</div>
      <div>
        <span class="user-info" id="usernameDisplay">Пользователь</span>
        <span class="logout" id="logout">Выйти</span>
      </div>
    </div>

    <div class="main">
      <div id="chart"></div>

      <div class="sidebar">
        <div class="card">
          <h3>Торговая пара</h3>
          <div class="controls">
            <button class="active" data-pair="BTC">BTC/USDT</button>
            <button data-pair="ETH">ETH/USDT</button>
            <button data-pair="BNB">BNB/USDT</button>
            <button data-pair="SOL">SOL/USDT</button>
            <button data-pair="XRP">XRP/USDT</button>
            <button data-pair="DOGE">DOGE/USDT</button>
            <button data-pair="ADA">ADA/USDT</button>
            <button data-pair="TRX">TRX/USDT</button>
            <button data-pair="LINK">LINK/USDT</button>
            <button data-pair="TON">TON/USDT</button>
            <!-- Добавь остальные по аналогии для топ-30 -->
          </div>
        </div>

        <div class="card">
          <h3>Статистика</h3>
          <div class="stats">
            <div class="stat"><div>Баланс</div><span id="balance">$10,000</span></div>
            <div class="stat"><div>PnL</div><span id="pnl">$0</span></div>
            <div class="stat"><div>Сделок</div><span id="tradesCount">0</span></div>
            <div class="stat"><div>Win Rate</div><span id="winRate">—</span></div>
          </div>
        </div>

        <div class="card">
          <h3>Последние сделки</h3>
          <div id="tradesList" class="trades"></div>
        </div>
      </div>
    </div>

    <div class="info-bar">
      <div>Пара: <strong id="currentPair">BTC/USDT</strong> | Тариф: <span id="currentPlan">Starter</span></div>
      <div>Время: <span id="clock">--:--:--</span></div>
    </div>
  </div>
</div>

<script>
  // === ПЕРЕМЕННЫЕ ===
  const authPage = document.getElementById('authPage');
  const plansPage = document.getElementById('plansPage');
  const dashboard = document.getElementById('dashboard');
  let users = JSON.parse(localStorage.getItem('tradingBotUsers') || '[]');
  let session = JSON.parse(localStorage.getItem('tradingBotSession') || 'null');
  let currentPlan = null;
  let currentPair = 'BTC';
  let isBotRunning = false;

  const title = document.getElementById('authTitle');
  const btn = document.getElementById('authBtn');
  const switchText = document.getElementById('switchText');
  const switchLink = document.getElementById('switchLink');
  const confirmPassword = document.getElementById('confirmPassword');

  // === АВТОРИЗАЦИЯ ===
  function toggleMode() {
    isLogin = !isLogin;
    title.textContent = isLogin ? 'Вход' : 'Регистрация';
    btn.textContent = isLogin ? 'Войти' : 'Создать аккаунт';
    switchText.innerHTML = isLogin ? 'Нет аккаунта? ' : 'Уже есть аккаунт? ';
    switchLink.textContent = isLogin ? 'Зарегистрироваться' : 'Войти';
    confirmPassword.style.display = isLogin ? 'none' : 'block';
  }
  switchLink.onclick = toggleMode;

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  btn.onclick = () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password) return alert('Заполните все поля!');
    if (!isValidEmail(email)) return alert('Введите корректный email!');

    if (isLogin) {
      const user = users.find(u => u.email === email && u.password === password);
      if (user) {
        session = { email };
        localStorage.setItem('tradingBotSession', JSON.stringify(session));
        showPlansPage();
      } else {
        alert('Неверный email или пароль');
      }
    } else {
      const confirm = document.getElementById('confirmPassword').value;
      if (password !== confirm) return alert('Пароли не совпадают!');
      if (users.some(u => u.email === email)) return alert('Пользователь с таким email уже существует!');

      users.push({ email, password });
      localStorage.setItem('tradingBotUsers', JSON.stringify(users));
      session = { email };
      localStorage.setItem('tradingBotSession', JSON.stringify(session));
      alert('Аккаунт создан! Теперь войдите.');
      toggleMode();
    }
  };

  function showPlansPage() {
    authPage.style.display = 'none';
    plansPage.style.display = 'block';
    document.getElementById('usernameDisplay').textContent = session.email;
  }

  document.getElementById('logout').onclick = () => {
    localStorage.removeItem('tradingBotSession');
    location.reload();
  };

  if (session) showPlansPage();

  // === ПОКУПКА ТАРИФА ===
  function buyPlan(plan, defaultPair) {
    currentPlan = plan;
    currentPair = defaultPair;
    localStorage.setItem('currentPlan', plan);
    localStorage.setItem('currentPair', defaultPair);
    alert(`Тариф "${plan}" куплен! Бот запущен на выбранный срок. Пара: ${defaultPair}/USDT`);
    showDashboard();
  }

  function showDashboard() {
    plansPage.style.display = 'none';
    dashboard.style.display = 'block';
    initTradingTerminal();
  }

  // === ТОРГОВЫЙ ТЕРМИНАЛ ===
  let chart, candleSeries, emaSeries, volumeSeries;
  let candles = [];
  let balance = 10000;
  let initialBalance = 10000;
  let trades = [];
  let markers = [];
  let ws = null;
  let isRunning = false;

  function initTradingTerminal() {
    initChart();
    updateUI();
    setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleTimeString(), 1000);
    loadHistoricalData();
    document.getElementById('currentPlan').textContent = currentPlan;
    document.querySelector(`[data-pair="${currentPair}"]`).classList.add('active');
    document.getElementById('currentPair').textContent = `${currentPair}/USDT`;
  }

  function initChart() {
    const el = document.getElementById('chart');
    chart = LightweightCharts.createChart(el, {
      width: el.clientWidth, height: 580,
      layout: { backgroundColor: '#111722', textColor: '#d1d4dc', fontFamily: 'Inter' },
      grid: { vertLines: { color: '#1a2a3a' }, horzLines: { color: '#1a2a3a' } },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#1a2a3a' },
      timeScale: { borderColor: '#1a2a3a', timeVisible: true, secondsVisible: false },
    });

    candleSeries = chart.addCandlestickSeries({
      upColor: '#00d4aa', downColor: '#ff5252',
      borderUpColor: '#00d4aa', borderDownColor: '#ff5252',
      wickUpColor: '#00d4aa', wickDownColor: '#ff5252',
    });

    emaSeries = chart.addLineSeries({ color: '#ffd700', lineWidth: 2 });
    volumeSeries = chart.addHistogramSeries({
      color: '#26a69a', priceScaleId: 'volume',
      priceFormat: { type: 'volume' }
    });

    chart.priceScale('volume').applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });

    window.addEventListener('resize', () => chart.applyOptions({ width: el.clientWidth }));
  }

  function connectBinanceWS() {
    if (ws) ws.close();
    const stream = `${currentPair}@kline_15m`;
    ws = new WebSocket(`wss://stream.binance.com:9443/ws/${stream}`);

    ws.onopen = () => console.log('Binance WS подключен');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.k && data.k.x) {
        const k = data.k;
        const candle = {
          time: k.t / 1000,
          open: parseFloat(k.o),
          high: parseFloat(k.h),
          low: parseFloat(k.l),
          close: parseFloat(k.c),
          volume: parseFloat(k.v)
        };
        candles.push(candle);
        if (candles.length > 200) candles.shift();
        updateChart();
        if (isRunning) checkForSignal(candle);
      }
    };
    ws.onclose = () => setTimeout(connectBinanceWS, 3000);
  }

  function loadHistoricalData() {
    const symbol = currentPair.toUpperCase() + 'USDT';
    fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=15m&limit=100`)
      .then(res => res.json())
      .then(data => {
        candles = data.map(d => ({
          time: d[0] / 1000,
          open: parseFloat(d[1]),
          high: parseFloat(d[2]),
          low: parseFloat(d[3]),
          close: parseFloat(d[4]),
          volume: parseFloat(d[5])
        }));
        updateChart();
      })
      .catch(() => {
        candles = generateMockCandles(100);
        updateChart();
      });
  }

  function generateMockCandles(count) {
    const base = currentPair === 'BTC' ? 65000 : 3400; // Пример
    let price = base;
    return Array.from({ length: count }, (_, i) => {
      const change = (Math.random() - 0.5) * 0.005;
      const open = price;
      price *= (1 + change);
      const close = price;
      const high = Math.max(open, close) * (1 + Math.random() * 0.002);
      const low = Math.min(open, close) * (1 - Math.random() * 0.002);
      return { time: Date.now() / 1000 - (count - i) * 900, open, high, low, close, volume: 1000 + Math.random() * 5000 };
    });
  }

  function updateChart() {
    if (candles.length === 0) return;

    candleSeries.setData(candles);

    if (candles.length >= 20) {
      const closes = candles.map(c => c.close);
      let ema = closes[19];
      const k = 2 / (20 + 1);
      const emaData = [{ time: candles[19].time, value: ema }];
      for (let i = 20; i < closes.length; i++) {
        ema = closes[i] * k + ema * (1 - k);
        emaData.push({ time: candles[i].time, value: ema });
      }
      emaSeries.setData(emaData);
    }

    volumeSeries.setData(candles.map(c => ({
      time: c.time,
      value: c.volume,
      color: c.close >= c.open ? '#00d4aa44' : '#ff525244'
    })));

    candleSeries.setMarkers(markers);
    chart.timeScale().scrollToRealTime();
  }

  function checkForSignal(candle) {
    if (candles.length < 21) return;
    const ema = emaSeries.getData().slice(-1)[0]?.value;
    if (!ema) return;

    const prevClose = candles[candles.length - 2].close;
    const signal = prevClose <= ema && candle.close > ema ? 'BUY' :
                   prevClose >= ema && candle.close < ema ? 'SELL' : null;

    if (signal && !trades.some(t => t.status === 'open')) {
      openTrade(signal, candle);
    }
  }

  function openTrade(signal, candle) {
    const tpPct = 0.03; // Фиксированные для простоты
    const slPct = 0.015;
    const duration = 24 * 3600000; // 24 часа

    const price = candle.close;
    const size = (balance * 0.1) / price; // 10% риска

    const trade = {
      id: Date.now(),
      time: candle.time,
      type: signal,
      entry: price,
      size: size,
      tp: price * (signal === 'BUY' ? 1 + tpPct : 1 - tpPct),
      sl: price * (signal === 'BUY' ? 1 - slPct : 1 + slPct),
      status: 'open',
      pnl: 0,
      closed: false
    };

    trades.unshift(trade);
    balance *= 0.999;

    markers.push({
      time: candle.time,
      position: signal === 'BUY' ? 'belowBar' : 'aboveBar',
      color: signal === 'BUY' ? '#00d4aa' : '#ff5252',
      shape: signal === 'BUY' ? 'arrowUp' : 'arrowDown',
      text: signal
    });

    updateUI();

    setTimeout(() => closeTradeByTime(trade), duration);
  }

  function closeTradeByTime(trade) {
    if (trade.closed) return;
    const lastCandle = candles[candles.length - 1];
    const exitPrice = lastCandle.close;
    closeTrade(trade, exitPrice);
  }

  function closeTrade(trade, exitPrice) {
    if (trade.closed) return;
    trade.closed = true;
    trade.exit = exitPrice;
    trade.pnl = trade.type === 'BUY'
      ? (exitPrice - trade.entry) * trade.size * 0.999
      : (trade.entry - exitPrice) * trade.size * 0.999;
    trade.status = 'closed';
    balance += trade.pnl;

    markers.push({
      time: candles[candles.length - 1].time,
      position: trade.type === 'BUY' ? 'aboveBar' : 'belowBar',
      color: trade.pnl > 0 ? '#00d4aa' : '#ff5252',
      shape: 'circle',
      text: trade.pnl > 0 ? `+$${trade.pnl.toFixed(2)}` : `$${trade.pnl.toFixed(2)}`
    });

    updateUI();
  }

  function updateUI() {
    document.getElementById('balance').textContent = `$${balance.toFixed(2)}`;
    const pnl = balance - initialBalance;
    document.getElementById('pnl').textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
    document.getElementById('tradesCount').textContent = trades.length;

    const closed = trades.filter(t => t.status === 'closed');
    const winRate = closed.length ? Math.round(closed.filter(t => t.pnl > 0).length / closed.length * 100) + '%' : '—';
    document.getElementById('winRate').textContent = winRate;

    document.getElementById('tradesList').innerHTML = trades.slice(0, 8).map(t => `
      <div class="trade ${t.type.toLowerCase()}">
        <div>${new Date(t.time * 1000).toLocaleTimeString()}</div>
        <div>${t.type} @ $${t.entry.toFixed(2)}</div>
        <div>${t.status === 'closed' ? (t.pnl > 0 ? '+' : '') + '$' + t.pnl.toFixed(2) : 'Открыта'}</div>
      </div>
    `).join('');

    document.getElementById('currentPair').textContent = `${currentPair}/USDT`;
  }

  // === СОБЫТИЯ ===
  document.querySelectorAll('[data-pair]').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('[data-pair]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentPair = btn.dataset.pair;
      candles = []; markers = [];
      loadHistoricalData();
      updateUI();
    };
  });

  document.getElementById('startBtn').onclick = () => {
    isRunning = !isRunning;
    if (isRunning) {
      connectBinanceWS();
      document.getElementById('startBtn').textContent = 'Остановить';
    } else {
      if (ws) ws.close();
      document.getElementById('startBtn').textContent = 'Запустить';
    }
  };
</script>

</body>
</html>
