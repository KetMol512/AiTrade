<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BoostEx — Demo (Polished) — Trading Bot & Wallet</title>
<style>
  /* Оставляем стили без изменений */
  :root{
    --bg: #071126;
    --panel: linear-gradient(180deg,#071827,#041124);
    --muted: #9fb0c7;
    --accent: #6ee7b7;
    --accent-2: #60a5fa;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --danger: #fb7185;
    --radius: 12px;
    --shadow: 0 8px 30px rgba(2,6,23,0.6);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: dark;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#041026 0%, #02101a 100%);color:#e6eef6}
  *{box-sizing:border-box}

  .wrap{max-width:1200px;margin:28px auto;padding:18px;display:grid;grid-template-columns:260px 1fr;gap:18px;align-items:start}
  header.appbar{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px;border-radius:var(--radius);background:var(--panel);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#042}
  h1{margin:0;font-size:18px}
  .subtitle{color:var(--muted);font-size:13px}

  aside.sidebar{display:flex;flex-direction:column;gap:14px}
  .panel{background:var(--panel);border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
  .balance {font-weight:700;font-size:20px;margin-top:6px}
  .controls-row{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .btn{background:linear-gradient(180deg,#142233,#0e2736);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:var(--accent);font-weight:700}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
  .btn.warn{background:linear-gradient(180deg,#5b1220,#7b2736);color:var(--danger)}
  .wallet-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .wallet-item{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px;border-radius:10px;background:var(--glass-2);font-size:13px}
  .addr{font-family:monospace;color:#bfeadf;font-size:12px;word-break:break-all}

  main.grid{display:grid;grid-template-columns:1fr;gap:18px}
  .card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
  .chart-wrap{height:360px;border-radius:10px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008))}
  canvas{width:100%;height:100%;display:block;border-radius:8px}

  .tx-list{max-height:240px;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px}

  #modalRoot{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:9999}
  #modalBg{position:absolute;left:0;top:0;width:100%;height:100%;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.6))}
  #modal{position:relative;z-index:10;max-width:820px;width:94%;border-radius:14px;padding:18px;background:linear-gradient(180deg,#041022,#071827);border:1px solid rgba(255,255,255,0.03)}

  @media (max-width:1100px){
    .wrap{grid-template-columns:1fr}
    main.grid{grid-template-columns:1fr}
  }

  .muted-2{color:rgba(255,255,255,0.6)}
  .meta{font-size:12px;color:var(--muted)}
  .inline {display:inline-flex;gap:6px;align-items:center}
  .speed-select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header class="appbar">
      <div class="brand">
        <div class="logo">B</div>
        <div>
          <h1>BoostEx</h1>
          <div class="subtitle">Trading Bot & Wallet — демонстрация</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div class="inline">
          <div class="meta">Обновление графика</div>
          <select id="speed" class="speed-select" title="Simulation speed">
            <option value="1000">1s (dev)</option>
            <option value="10000">10s</option>
            <option value="60000" selected>60s (real)</option>
          </select>
        </div>
        <button id="btnTelegram" class="btn">Войти через Telegram</button>
        <button id="btnRegister" class="btn ghost">Регистрация</button>
        <button id="btnLogin" class="btn ghost">Вход</button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="panel">
        <div class="small">Баланс</div>
        <div class="balance" id="totalBalance">—</div>
        <div class="small" id="btcBalance">BTC: —</div>
        <div class="small">USD эквивалент — симуляция</div>
        <div style="height:10px"></div>
        <div class="controls-row">
          <button id="btnDeposit" class="btn">Пополнить</button>
          <button id="btnConvert" class="btn ghost">Конвертировать</button>
        </div>
        <div style="height:10px"></div>
        <div class="small">Профит бота: <strong id="botPnl">—</strong></div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Мои адреса</div>
          <button id="btnNewAddress" class="btn ghost">Новый</button>
        </div>
        <div class="wallet-list" id="walletList"></div>
        <div style="height:8px"></div>
        <div class="meta">Адреса генерируются локально (демо). В проде — /wallets.</div>
      </div>
    </aside>

    <main class="grid">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <div class="small">Trading Bot · ИИ-симуляция BTC/USDT</div>
            <div style="font-weight:700">Автоматическая торговля</div>
            <div class="meta" style="margin-top:6px">Реалистичная симуляция: сделки влияют на баланс, комиссии 0.1%, стратегии с EMA.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnStartBot" class="btn">Запустить</button>
            <button id="btnStopBot" class="btn ghost">Остановить</button>
            <button id="btnResetBot" class="btn ghost">Сбросить</button>
            <button id="btnConfigBot" class="btn ghost">Настроить</button>
          </div>
        </div>

        <div class="chart-wrap">
          <canvas id="botChart"></canvas>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="small">Стратегии: mean-revert · momentum · hybrid</div>
          <div class="small">Время: <span id="botTime">—</span></div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <div class="small">История транзакций</div>
            <div style="font-weight:700">Последние операции</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnExport" class="btn ghost">Экспорт CSV</button>
            <div class="meta">Доступно после входа</div>
          </div>
        </div>
        <div class="tx-list" id="txList"></div>
      </section>
    </main>
  </div>

  <div id="modalRoot">
    <div id="modalBg"></div>
    <div id="modal"></div>
  </div>

<script>
/* =========================
   Polished demo logic with realistic trading
   - Fixed: Added exportCSV
   - Debug: Added console logs for button bindings
   ========================= */

const STORAGE = 'boostex_polished_v1'

let state = {
  user: null,
  wallets: [],
  txs: [],
  balance: { USDT: 1250.50, BTC: 0 },
  bot: { 
    running: false, 
    points: [], 
    pnl: 0, 
    baseBalance: 1250.50,
    lastPrice: 1000, 
    strategy: 'mean-revert', 
    risk: 1, 
    duration: 86400000, 
    startTime: null,
    ema: [],
    positions: { btc: 0 }
  }
}

try {
  const raw = localStorage.getItem(STORAGE)
  if(raw) Object.assign(state, JSON.parse(raw))
} catch(e){ console.warn('Error loading state:', e) }

function saveState(){ localStorage.setItem(STORAGE, JSON.stringify(state)) }

const USER_STORE = 'boostex_polished_users'
function loadUsers(){ try{ return JSON.parse(localStorage.getItem(USER_STORE) || '{}') }catch(e){return{}} }
function saveUsers(u){ localStorage.setItem(USER_STORE, JSON.stringify(u)) }

function uid(len=8){ return Math.random().toString(36).slice(2,2+len) }
function fmt(n){ return (Math.round(n*100)/100).toLocaleString('ru-RU') }
function nowTime(){ return new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) }
function setStatus(s){ document.getElementById('botTime').textContent = s }

const totalBalanceEl = document.getElementById('totalBalance')
const btcBalanceEl = document.getElementById('btcBalance')
const txListEl = document.getElementById('txList')
const botPnlEl = document.getElementById('botPnl')
const speedSelect = document.getElementById('speed')

function requireAuth(fn){
  if(state.user) return fn()
  showModal(`<h2>Требуется вход</h2>
    <div class="meta">Чтобы использовать эту функцию, войдите или зарегистрируйтесь.</div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" onclick="openLoginModal()">Вход</button>
      <button class="btn ghost" onclick="openRegisterModal()">Регистрация</button>
      <button class="btn ghost" onclick="modalClose()">Отмена</button>
    </div>`)
}

function openRegisterModal(){
  showModal(`<h2>Регистрация</h2>
    <div style="margin-top:8px"><label class="small">Email</label><input id="regEmail" type="email" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" /></div>
    <div style="margin-top:8px"><label class="small">Пароль</label><input id="regPass" type="password" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" /></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" onclick="doRegister()">Создать</button><button class="btn ghost" onclick="modalClose()">Отмена</button></div>
    <div class="meta" style="margin-top:8px">Демо: пароли хранятся локально (не для продакшна).</div>`)
}
function doRegister(){
  const email = document.getElementById('regEmail').value?.trim()
  const pass = document.getElementById('regPass').value || ''
  if(!email || pass.length < 6){ alert('Введите email и пароль >=6'); return }
  const users = loadUsers()
  if(users[email]){ alert('Пользователь существует'); return }
  users[email] = { id: 'u_'+uid(6), name: email.split('@')[0], passB64: btoa(pass) }
  saveUsers(users)
  modalClose()
  showModal(`<h2>Готово</h2><div class="meta">Аккаунт создан. Войдите.</div><div style="margin-top:12px"><button class="btn" onclick="modalClose();openLoginModal()">Войти</button></div>`)
}

function openLoginModal(){
  showModal(`<h2>Вход</h2>
    <div style="margin-top:8px"><label class="small">Email</label><input id="loginEmail" type="email" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" /></div>
    <div style="margin-top:8px"><label class="small">Пароль</label><input id="loginPass" type="password" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" /></div>
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" onclick="doLogin()">Войти</button><button class="btn ghost" onclick="modalClose()">Отмена</button></div>`)
}
function doLogin(){
  const email = document.getElementById('loginEmail').value?.trim()
  const pass = document.getElementById('loginPass').value || ''
  const users = loadUsers()
  if(!users[email] || users[email].passB64 !== btoa(pass)){ alert('Неверный логин/пароль'); return }
  const u = users[email]
  state.user = { id: u.id, email, name: u.name }
  saveState(); modalClose(); syncUI(); addTx({ type:'auth', amount:'—', coin:'—', note:`Login ${email}`, status:'ok' })
}

const BOT_USERNAME = 'YourBotUsername'
function startTelegramFlow(){
  const token = uid(14)
  localStorage.setItem('tg_pending_'+token, JSON.stringify({ at: Date.now() }))
  const url = `https://t.me/${BOT_USERNAME}?start=${token}`
  window.open(url, '_blank')
  showModal(`<h2>Вход через Telegram</h2>
    <div class="meta">Открылось Telegram. Найдите бота <strong>@${BOT_USERNAME}</strong> и нажмите /start. После этого вернитесь и нажмите «Проверить привязку».</div>
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" onclick="checkTelegram('${token}')">Проверить привязку</button><button class="btn ghost" onclick="modalClose()">Отмена</button></div>`)
}
function checkTelegram(token){
  const pending = localStorage.getItem('tg_pending_'+token)
  if(!pending){ alert('Токен не найден. Сначала нажмите ссылку и /start в боте.'); return }
  setTimeout(()=>{
    const tgUser = 'tg_' + uid(6)
    const tgId = 'tgid_' + uid(7)
    if(state.user){
      state.user.telegram = tgUser; state.user.telegramId = tgId
      saveState(); syncUI(); addTx({ type:'auth', amount:'—', coin:'—', note:`Telegram linked @${tgUser}`, status:'ok' })
      modalClose(); alert(`Telegram @${tgUser} привязан`)
      return
    }
    const email = `${tgUser}@telegram.local`
    const users = loadUsers()
    if(!users[email]) users[email] = { id: 'u_'+uid(6), name: tgUser, passB64: btoa(uid(12)), telegram: tgUser }
    state.user = { id: users[email].id, email, name: tgUser, telegram: tgUser, telegramId: tgId }
    saveState(); saveUsers(users); syncUI(); addTx({ type:'auth', amount:'—', coin:'—', note:`Login via Telegram @${tgUser}`, status:'ok' })
    modalClose(); alert(`Вход выполнен как ${tgUser}`)
  }, 700)
}

function createAddress(coin='USDT', network='TRC-20'){
  return requireAuth(()=> {
    const addr = (network==='TRC-20' ? 'T' : '0x') + uid(28)
    const w = { id: uid(6), coin, network, address: addr }
    state.wallets.push(w); addTx({ type:'address', amount:'—', coin, note:`Create ${network}`, status:'ok' }); saveState(); syncUI()
    return w
  })
}
function addTx(tx){ tx.id = uid(8); tx.time = nowTime(); state.txs.push(tx); saveState(); renderTx() }

function openDeposit(addr){
  return requireAuth(()=> {
    showModal(`<h2>Пополнение</h2><div class="meta">Адрес для пополнения:</div><pre style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:8px;font-family:monospace">${addr}</pre>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" onclick="modalClose()">Закрыть</button></div>`)
  })
}

function openConvert(){
  return requireAuth(()=> {
    showModal(`<h2>Конвертация</h2>
      <div style="margin-top:8px"><label class="small">От</label><select id="fromCoin" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)"><option>USDT</option><option>USDC</option></select></div>
      <div style="margin-top:8px"><label class="small">Кому</label><select id="toCoin" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)"><option>USDT</option><option>USDC</option></select></div>
      <div style="margin-top:8px"><label class="small">Сумма</label><input id="convAmount" type="number" value="100" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)"/></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" onclick="doConvert()">Конвертировать</button><button class="btn ghost" onclick="modalClose()">Отмена</button></div>`)
  })
}
function doConvert(){
  const from = document.getElementById('fromCoin').value
  const to = document.getElementById('toCoin').value
  let amount = Number(document.getElementById('convAmount').value) || 0
  if(from===to){ alert('Нельзя'); return }
  const fee = amount*0.005; amount = amount - fee
  state.balance.USDT = Math.max(0, state.balance.USDT - (from==='USDT' ? (Number(document.getElementById('convAmount').value)||0) : 0) + (to==='USDT'?amount:0))
  addTx({ type:'convert', amount: fmt(amount), coin: to, note:`Convert ${from}→${to} (fee ${fmt(fee)})`, status:'ok' })
  saveState(); modalClose(); renderBalance()
}

function openAdminWithdraw(){
  return requireAuth(()=> {
    if(!state.isAdmin){ alert('Требуется admin mode'); return }
    showModal(`<h2>Admin Withdraw</h2><div style="margin-top:8px"><label class="small">Адрес</label><input id="awAddr" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" value="T_dest_..." /></div>
      <div style="margin-top:8px"><label class="small">Сумма</label><input id="awAmt" type="number" value="100" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" /></div>
      <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" onclick="doAdminWithdraw()">Выполнить</button><button class="btn ghost" onclick="modalClose()">Отмена</button></div>`)
  })
}
function doAdminWithdraw(){
  const addr = document.getElementById('awAddr').value
  const amt = Number(document.getElementById('awAmt').value)||0
  addTx({ type:'withdraw', amount: amt, coin:'USDT', note:`Admin withdraw to ${addr}`, status:'ok' })
  state.balance.USDT = Math.max(0, state.balance.USDT - amt); saveState(); renderBalance(); modalClose()
}

function openBotConfigModal() {
  return requireAuth(() => {
    showModal(`
      <h2>Настройки бота</h2>
      <div style="margin-top:8px">
        <label class="small">Стратегия</label>
        <select id="botStrategy" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
          <option value="mean-revert" ${state.bot.strategy === 'mean-revert' ? 'selected' : ''}>Mean Revert</option>
          <option value="momentum" ${state.bot.strategy === 'momentum' ? 'selected' : ''}>Momentum</option>
          <option value="hybrid" ${state.bot.strategy === 'hybrid' ? 'selected' : ''}>Hybrid</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label class="small">Риск (%)</label>
        <input id="botRisk" type="number" value="${state.bot.risk || 1}" min="0.1" max="10" step="0.1" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)" />
      </div>
      <div style="margin-top:8px">
        <label class="small">Длительность работы</label>
        <select id="botDuration" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
          <option value="3600000" ${state.bot.duration === 3600000 ? 'selected' : ''}>1 час</option>
          <option value="86400000" ${state.bot.duration === 86400000 ? 'selected' : ''}>1 день</option>
          <option value="604800000" ${state.bot.duration === 604800000 ? 'selected' : ''}>7 дней</option>
          <option value="2592000000" ${state.bot.duration === 2592000000 ? 'selected' : ''}>30 дней</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="saveBotConfig()">Сохранить</button>
        <button class="btn ghost" onclick="modalClose()">Отмена</button>
      </div>
      <div class="meta" style="margin-top:8px">Выберите стратегию, уровень риска и длительность работы бота.</div>
    `);
  });
}

function saveBotConfig() {
  const strategy = document.getElementById('botStrategy').value;
  const risk = Number(document.getElementById('botRisk').value) || 1;
  const duration = Number(document.getElementById('botDuration').value) || 86400000;
  state.bot.strategy = strategy;
  state.bot.risk = Math.min(Math.max(risk, 0.1), 10);
  state.bot.duration = duration;
  addTx({ type: 'bot', amount: '—', coin: '—', note: `Bot config: ${strategy}, risk ${state.bot.risk}%, duration ${duration/3600000}ч`, status: 'ok' });
  saveState();
  modalClose();
  setStatus(`Стратегия: ${strategy}, риск: ${state.bot.risk}%, длительность: ${duration/3600000}ч`);
}

function showModal(html){ 
  document.getElementById('modalRoot').style.display='flex'; 
  document.getElementById('modal').innerHTML = html 
}
function modalClose(){ 
  document.getElementById('modalRoot').style.display='none'; 
  document.getElementById('modal').innerHTML = '' 
}

function exportCSV() {
  if(!state.user) return alert('Требуется вход для экспорта');
  const headers = ['ID', 'Time', 'Type', 'Amount', 'Coin', 'Note', 'Status'];
  const csv = [
    headers.join(','),
    ...state.txs.map(tx => [
      tx.id,
      `"${tx.time}"`,
      tx.type,
      tx.amount,
      tx.coin || '',
      `"${tx.note || ''}"`,
      tx.status
    ].join(','))
  ].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `boostex_txs_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function renderBalance(){
  totalBalanceEl.textContent = `${fmt(state.balance.USDT)} USDT`;
  btcBalanceEl.textContent = `BTC: ${fmt(state.bot.positions.btc)}`;
}
function renderWallets(){
  walletListEl.innerHTML = ''
  state.wallets.forEach(w=>{
    const div = document.createElement('div'); div.className='wallet-item'
    div.innerHTML = `<div style="flex:1"><div class="small">${w.coin} · ${w.network}</div><div class="addr">${w.address}</div></div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end"><button class="btn ghost" data-addr="${w.address}">Копировать</button><button class="btn" data-addr="${w.address}">Пополнить</button></div>`
    walletListEl.appendChild(div)
  })
  if(state.wallets.length === 0) walletListEl.innerHTML = `<div class="small muted">Нет адресов — создайте</div>`
  walletListEl.querySelectorAll('button').forEach(btn => {
    btn.onclick = (e) => {
      const addr = e.currentTarget.dataset.addr
      if(e.currentTarget.textContent.includes('Копировать')) navigator.clipboard?.writeText(addr).then(()=>alert('Скопировано'))
      else openDeposit(addr)
    }
  })
}
function renderTx(){
  txListEl.innerHTML = ''
  state.txs.slice().reverse().forEach(t=>{
    const el = document.createElement('div'); el.className = 'wallet-item'
    el.style.justifyContent = 'space-between'
    el.innerHTML = `<div style="flex:1"><div style="font-weight:700">${t.type} · ${t.amount} ${t.coin||''}</div><div class="meta">${t.note||''}</div></div><div style="text-align:right"><div class="meta">${t.time}</div><div style="margin-top:6px"><span style="padding:6px;border-radius:999px;background:rgba(255,255,255,0.02)">${t.status}</span></div></div>`
    txListEl.appendChild(el)
  })
  if(state.txs.length === 0) txListEl.innerHTML = `<div class="small muted">Нет транзакций</div>`
}

try {
  document.getElementById('btnRegister').onclick = () => { console.log('btnRegister clicked'); openRegisterModal(); }
  document.getElementById('btnLogin').onclick = () => { console.log('btnLogin clicked'); openLoginModal(); }
  document.getElementById('btnTelegram').onclick = () => { console.log('btnTelegram clicked'); startTelegramFlow(); }
  document.getElementById('btnNewAddress').onclick = () => { console.log('btnNewAddress clicked'); createAddress('USDT','TRC-20'); }
  document.getElementById('btnDeposit').onclick = () => { 
    console.log('btnDeposit clicked');
    if(state.wallets.length === 0) { createAddress().then(w=> openDeposit(w.address)) }
    else requireAuth(()=> openDeposit(state.wallets[0].address))
  }
  document.getElementById('btnConvert').onclick = () => { console.log('btnConvert clicked'); openConvert(); }
  document.getElementById('btnExport').onclick = () => { console.log('btnExport clicked'); requireAuth(exportCSV); }
  document.getElementById('btnConfigBot').onclick = () => { console.log('btnConfigBot clicked'); openBotConfigModal(); }
  document.getElementById('btnStartBot').onclick = () => { console.log('btnStartBot clicked'); requireAuth(startBot); }
  document.getElementById('btnStopBot').onclick = () => { console.log('btnStopBot clicked'); requireAuth(stopBot); }
  document.getElementById('btnResetBot').onclick = () => { console.log('btnResetBot clicked'); requireAuth(resetBot); }
} catch(e) {
  console.error('Error binding buttons:', e);
}

const canvas = document.getElementById('botChart')
const ctx = canvas.getContext('2d')
let DPR = window.devicePixelRatio || 1
function resizeCanvas(){
  canvas.width = canvas.clientWidth * DPR
  canvas.height = canvas.clientHeight * DPR
  drawChart()
}
window.addEventListener('resize', resizeCanvas)

if(state.bot.points.length === 0){
  const start = 60000 + (Math.random()-0.5)*2000;
  state.bot.lastPrice = start
  const pts = Array.from({length:60}, (_,i) => start + Math.sin(i/3)*300 + (Math.random()-0.5)*800);
  state.bot.points = pts;
  state.bot.baseBalance = state.balance.USDT + state.bot.positions.btc * start;
  state.bot.pnl = 0;
  state.bot.ema = calculateEMA(pts, 20);
}

function calculateEMA(prices, period) {
  const ema = [];
  let sma = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
  ema.push(sma);
  const multiplier = 2 / (period + 1);
  for (let i = period; i < prices.length; i++) {
    sma = (prices[i] - sma) * multiplier + sma;
    ema.push(sma);
  }
  return ema;
}

function generateNextPrice(prev){
  const mu = 60000;
  const theta = 0.02;
  const sigma = 800 * (state.bot.risk || 1) / 10;
  const dt = 1;
  const dw = (Math.random()-0.5)*Math.sqrt(dt);
  const meanRevert = theta*(mu - prev)*dt;
  let next = prev + meanRevert + sigma * dw + (Math.random()-0.5)*100;
  if(Math.random() < 0.05){ next *= (1 + (Math.random()-0.5)*0.02); }
  return Math.max(1000, next);
}

function drawChart(){
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.save(); ctx.scale(DPR,DPR)
  const W = canvas.clientWidth, H = canvas.clientHeight
  ctx.fillStyle = 'rgba(4,8,14,0.6)'; ctx.fillRect(0,0,W,H)
  const padL = 48, padR = 12, padT = 14, padB = 28
  const plotW = W - padL - padR, plotH = H - padT - padB
  const pts = state.bot.points.length ? state.bot.points : [state.bot.lastPrice]
  const minP = Math.min(...pts) * 0.995
  const maxP = Math.max(...pts) * 1.005
  const xrange = pts.length - 1
  const yScale = (v) => padT + (maxP - v) / (maxP - minP || 1) * plotH
  const xScale = (i) => padL + (i / (xrange || 1)) * plotW
  ctx.strokeStyle = 'rgba(255,255,255,0.03)'; ctx.lineWidth = 1
  ctx.beginPath()
  for(let g=0; g<=4; g++){
    const y = padT + (g/4)*plotH
    ctx.moveTo(padL, y); ctx.lineTo(W-padR, y)
  }
  ctx.stroke()
  ctx.fillStyle = 'rgba(205,230,220,0.9)'; ctx.font = '12px Inter, Arial'
  for(let g=0; g<=4; g++){
    const y = padT + (g/4)*plotH
    const price = (maxP - (g/4)*(maxP-minP))
    ctx.fillText(fmt(price), 8, y+4)
  }
  ctx.beginPath()
  for(let i=0;i<pts.length;i++){
    const x = xScale(i), y = yScale(pts[i])
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)
  }
  ctx.strokeStyle = 'rgba(110,231,183,0.95)'; ctx.lineWidth = 2.5; ctx.stroke()
  ctx.lineTo(xScale(pts.length-1), padT+plotH); ctx.lineTo(xScale(0), padT+plotH); ctx.closePath()
  ctx.fillStyle = 'rgba(110,231,183,0.06)'; ctx.fill()
  if(state.bot.ema.length > 0){
    ctx.beginPath()
    for(let i=0; i<state.bot.ema.length; i++){
      const x = xScale(i + pts.length - state.bot.ema.length), y = yScale(state.bot.ema[i])
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)
    }
    ctx.strokeStyle = 'rgba(251,113,133,0.7)'; ctx.lineWidth = 1.5; ctx.stroke()
  }
  const last = pts[pts.length-1]
  const lastX = xScale(pts.length-1), lastY = yScale(last)
  ctx.fillStyle = '#cdefdc'; ctx.beginPath(); ctx.arc(lastX, lastY, 4, 0, Math.PI*2); ctx.fill()
  for(let i=0;i<pts.length;i++){
    const x = xScale(i)
    const vol = Math.abs(Math.round((Math.sin(i/3)+1)*3000 + (Math.random()*2000)));
    const h = Math.min(24, vol/100)
    ctx.fillStyle = 'rgba(110,231,183,0.08)'; ctx.fillRect(x-2, padT+plotH - h, 3, h)
  }
  ctx.fillStyle = '#cdefdc'; ctx.font = '13px Inter, Arial'
  ctx.fillText('BTC Price: ' + fmt(last) + ' USDT', padL, padT - 2)
  const pnl = state.bot.pnl
  ctx.fillStyle = pnl >=0 ? 'rgba(110,231,183,0.95)' : 'rgba(251,113,133,0.95)'
  ctx.fillText('P&L: ' + (pnl>=0?'+':'') + fmt(pnl) + ' USDT', padL+160, padT-2)
  ctx.restore()
}

function tick(){
  if(state.bot.startTime && state.bot.duration) {
    const elapsed = Date.now() - state.bot.startTime
    if(elapsed >= state.bot.duration) {
      stopBot()
      addTx({ type:'bot', amount:'—', coin:'—', note:'Bot stopped: duration expired', status:'ok' })
      setStatus(`Бот остановлен: время истекло`)
      return
    }
  }
  const currentBalance = state.balance.USDT + state.bot.positions.btc * state.bot.lastPrice
  if(currentBalance < state.bot.baseBalance * 0.9) {
    stopBot()
    addTx({ type:'bot', amount:'—', coin:'—', note:'Bot stopped: risk limit reached', status:'ok' })
    setStatus(`Бот остановлен: лимит риска`)
    return
  }
  const prev = state.bot.lastPrice
  const next = generateNextPrice(prev)
  state.bot.points.push(next)
  if(state.bot.points.length > 120) state.bot.points.shift()
  state.bot.lastPrice = next
  const emaPeriod = 20
  if(state.bot.ema.length < emaPeriod - 1) {
    state.bot.ema.push(next)
  } else {
    const lastEma = state.bot.ema[state.bot.ema.length - 1]
    const multiplier = 2 / (emaPeriod + 1)
    const newEma = (next - lastEma) * multiplier + lastEma
    state.bot.ema.push(newEma)
    if(state.bot.ema.length > 120) state.bot.ema.shift()
  }
  executeTrade(next)
  state.bot.pnl = (state.balance.USDT + state.bot.positions.btc * next) - state.bot.baseBalance
  botPnlEl.textContent = `${fmt(state.bot.pnl)} USDT`
  drawChart(); saveState(); renderBalance()
  document.getElementById('botTime').textContent = nowTime()
}

function executeTrade(price) {
  const threshold = 0.5 * (10 / state.bot.risk);
  const ema = state.bot.ema[state.bot.ema.length - 1] || price
  const momentum = state.bot.points.slice(-5).reduce((acc, p, i, arr) => acc + (i > 0 ? p - arr[i-1] : 0), 0) / 4
  let side = null
  let vol = 0
  switch(state.bot.strategy) {
    case 'mean-revert':
      if(price < ema * (1 - threshold / 100)) side = 'BUY'
      else if(price > ema * (1 + threshold / 100)) side = 'SELL'
      break
    case 'momentum':
      if(momentum > threshold * 10) side = 'BUY'
      else if(momentum < -threshold * 10) side = 'SELL'
      break
    case 'hybrid':
      if(price < ema * (1 - threshold / 100) && momentum > 0) side = 'BUY'
      else if(price > ema * (1 + threshold / 100) && momentum < 0) side = 'SELL'
      break
  }
  if(side) {
    const feeRate = 0.001
    const slippage = 0.0005
    let execPrice = side === 'BUY' ? price * (1 + slippage) : price * (1 - slippage)
    if(side === 'BUY' && state.balance.USDT > 0) {
      vol = (state.balance.USDT * (state.bot.risk / 100)) / execPrice
      const cost = vol * execPrice
      const fee = cost * feeRate
      if(cost + fee <= state.balance.USDT) {
        state.balance.USDT -= cost + fee
        state.bot.positions.btc += vol
        addTx({ type:'trade', amount: fmt(vol), coin:'BTC', note:`${side} ${fmt(vol)} BTC @ ${fmt(execPrice)} (fee ${fmt(fee)})`, status:'ok' })
      }
    } else if(side === 'SELL' && state.bot.positions.btc > 0) {
      vol = Math.min(state.bot.positions.btc, state.bot.positions.btc * (state.bot.risk / 100))
      const proceeds = vol * execPrice
      const fee = proceeds * feeRate
      state.bot.positions.btc -= vol
      state.balance.USDT += proceeds - fee
      addTx({ type:'trade', amount: fmt(vol), coin:'BTC', note:`${side} ${fmt(vol)} BTC @ ${fmt(execPrice)} (fee ${fmt(fee)})`, status:'ok' })
    }
  }
}

let intervalId = null
function startBot(){
  if(state.bot.running) return
  state.bot.running = true
  state.bot.startTime = Date.now()
  state.bot.baseBalance = state.balance.USDT + state.bot.positions.btc * state.bot.lastPrice
  const delay = Number(speedSelect.value) || 60000
  tick()
  intervalId = setInterval(tick, delay)
  addTx({ type:'bot', amount:'—', coin:'—', note:'Bot started', status:'ok' })
  saveState()
}
function stopBot(){
  if(intervalId) clearInterval(intervalId); intervalId = null; state.bot.running = false
  state.bot.startTime = null
  addTx({ type:'bot', amount:'—', coin:'—', note:'Bot stopped', status:'ok' }); saveState()
}
function resetBot(){
  state.bot.points = []; state.bot.ema = []; state.bot.baseBalance = 1250.50; state.bot.pnl = 0; state.bot.lastPrice = 60000; state.bot.positions.btc = 0
  state.balance.USDT = 1250.50; state.balance.BTC = 0
  state.bot.startTime = null
  addTx({ type:'bot', amount:'—', coin:'—', note:'Bot reset', status:'ok' }); saveState(); drawChart(); renderBalance()
}

speedSelect.onchange = ()=>{
  if(state.bot.running){ stopBot(); startBot() }
}

function syncUI(){
  renderBalance(); renderWallets(); renderTx()
  botPnlEl.textContent = `${fmt(state.bot.pnl)} USDT`
  if(state.user) document.querySelector('.subtitle').textContent = `Вошёл: ${state.user.name || state.user.email || state.user.telegram}`
  else document.querySelector('.subtitle').textContent = `Trading Bot & Wallet — демонстрация`
  const header = document.querySelector('.appbar')
  const existing = document.getElementById('adminToggle')
  if(state.user && !existing){
    const toggle = document.createElement('label'); toggle.id='adminToggle'; toggle.className='inline'; toggle.style.marginLeft='12px'
    toggle.innerHTML = `<span class="meta">Admin</span><input type="checkbox" id="adminChk" style="margin-left:6px">`
    header.appendChild(toggle)
    document.getElementById('adminChk').onchange = (e)=>{ state.isAdmin = e.target.checked; saveState(); syncUI() }
  } else if(!state.user && existing){ existing.remove() }
}
syncUI(); resizeCanvas(); drawChart()

if(state.wallets.length === 0){
  state.wallets.push({ id:uid(6), coin:'USDT', network:'TRC-20', address: 'T'+uid(28) })
  state.wallets.push({ id:uid(6), coin:'USDT', network:'ERC-20', address: '0x'+uid(28) })
  addTx({ type:'deposit', amount:200, coin:'USDT', note:'Initial demo deposit', status:'ok' }); saveState()
}

window.openRegisterModal = openRegisterModal
window.openLoginModal = openLoginModal
window.modalClose = modalClose
window.checkTelegram = checkTelegram
window.createAddress = createAddress
window.exportCSV = exportCSV
window.openBotConfigModal = openBotConfigModal
window.saveBotConfig = saveBotConfig

if(state.bot.running){ startBot() }

</script>
</body>
</html>
